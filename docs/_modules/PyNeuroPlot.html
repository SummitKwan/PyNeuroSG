<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>PyNeuroPlot &#8212; PyNeuroSG 0.1.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for PyNeuroPlot</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">mpl_toolkits</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">signal</span> <span class="k">as</span> <span class="n">sgn</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">misc_tools</span>
<span class="kn">import</span> <span class="nn">signal_align</span>
<span class="kn">import</span> <span class="nn">df_ana</span>
<span class="kn">import</span> <span class="nn">PyNeuroAna</span> <span class="k">as</span> <span class="nn">pna</span>

<span class="n">mpl</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;ggplot&#39;</span><span class="p">)</span>



<span class="sd">&quot;&quot;&quot; df (pandas DataFrame) related opeartions &quot;&quot;&quot;</span>
<span class="c1"># from df_ana import GroupPlot, DfPlot</span>


<div class="viewcode-block" id="SpkWfPlot"><a class="viewcode-back" href="../index.html#PyNeuroPlot.SpkWfPlot">[docs]</a><span class="k">def</span> <span class="nf">SpkWfPlot</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="n">sortcode_min</span> <span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sortcode_max</span> <span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot spk waveforms of a segment, one channel per axes, different sort codes are color coded</span>

<span class="sd">    :param seg:          neo blk.segment</span>
<span class="sd">    :param sortcode_min: the min sortcode included in the plot, default to 1</span>
<span class="sd">    :param sortcode_max: the max sortcode included in the plot, default to 1</span>
<span class="sd">    :param ncols:        number of columns in the subplot</span>
<span class="sd">    :return:             figure handle</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">N_chan</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">item</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="s1">&#39;channel_index&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">seg</span><span class="o">.</span><span class="n">spiketrains</span><span class="p">])</span>   <span class="c1"># ! depend on the frame !</span>
    <span class="k">if</span> <span class="n">ncols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">AutoRowCol</span><span class="p">(</span><span class="n">N_chan</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nrows</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">N_chan</span> <span class="o">/</span> <span class="n">ncols</span><span class="p">))</span>
    <span class="c1"># spike waveforms:</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes2d</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
                               <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">axes1d</span> <span class="o">=</span> <span class="n">axes2d</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">sortcode_color</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">225</span><span class="p">,</span> <span class="mi">217</span><span class="p">,</span> <span class="mi">111</span><span class="p">])</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span>
                      <span class="mi">1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">149</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">128</span><span class="p">])</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span>
                      <span class="mi">2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">112</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">234</span><span class="p">])</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span>
                      <span class="mi">3</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">142</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">194</span><span class="p">])</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span>
                      <span class="mi">4</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">202</span><span class="p">,</span>  <span class="mi">66</span><span class="p">,</span>  <span class="mi">45</span><span class="p">])</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span>
                      <span class="mi">5</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">229</span><span class="p">,</span> <span class="mi">145</span><span class="p">,</span>  <span class="mi">66</span><span class="p">])</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">axes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes1d</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="s1">&#39;C</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">transform</span><span class="o">=</span><span class="n">axes</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1"># for differenet versions of matploblib</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">h_axes_top</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">([</span><span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">h_axes_top</span><span class="o">.</span><span class="n">set_axis_bgcolor</span><span class="p">([</span><span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">spiketrains</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cur_chan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;Chan(\d*) .*&#39;</span><span class="p">,</span> <span class="n">seg</span><span class="o">.</span><span class="n">spiketrains</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># ! depend on the naming !</span>
            <span class="n">cur_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;.* Code(\d*)&#39;</span><span class="p">,</span> <span class="n">seg</span><span class="o">.</span><span class="n">spiketrains</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># ! depend on the naming !</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">cur_chan</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">cur_code</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="nb">print</span> <span class="p">(</span><span class="n">misc_tools</span><span class="o">.</span><span class="n">red_text</span><span class="p">(</span><span class="s1">&#39;the segment does not contain name like &quot;Chan1 Code2&quot;&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">sortcode_min</span> <span class="o">&lt;=</span> <span class="n">cur_code</span> <span class="o">&lt;</span> <span class="n">sortcode_max</span><span class="p">:</span>
            <span class="n">axes_cur</span> <span class="o">=</span> <span class="n">axes1d</span><span class="p">[</span><span class="n">cur_chan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">axes_cur</span><span class="p">)</span>
            <span class="n">h_text</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.12</span> <span class="o">*</span> <span class="n">cur_code</span><span class="p">,</span> <span class="s1">&#39;N=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">spiketrains</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span> <span class="n">transform</span><span class="o">=</span><span class="n">axes_cur</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;smaller&#39;</span><span class="p">)</span>
            <span class="n">h_waveform</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">spiketrains</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">waveforms</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">cur_code</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cur_code</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">h_waveform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">sortcode_color</span><span class="p">[</span><span class="n">cur_code</span><span class="p">])</span>
                <span class="n">h_text</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">sortcode_color</span><span class="p">[</span><span class="n">cur_code</span><span class="p">])</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">())))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>    <span class="c1"># make y_lim symmetrical</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;spike waveforms, y_range=</span><span class="si">{}</span><span class="s1"> uV&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()))</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="p">))</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="ErpPlot_singlePanel"><a class="viewcode-back" href="../index.html#PyNeuroPlot.ErpPlot_singlePanel">[docs]</a><span class="k">def</span> <span class="nf">ErpPlot_singlePanel</span><span class="p">(</span><span class="n">erp</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tf_inverse_color</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="n">c_lim_style</span><span class="o">=</span><span class="s1">&#39;diverge&#39;</span><span class="p">,</span> <span class="n">trace_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ERP plot in a single panel, where trace and color plot are superimposed. ideal for ERP recorded with linear probe</span>

<span class="sd">    :param erp:   erp traces, [N_chan, N_ts]</span>
<span class="sd">    :param ts:    timestapes</span>
<span class="sd">    :param tf_inverse_color:  if inverse sign for color plot.  Useful for CSD plot since minus &quot;sink&quot; are commonly plot as red</span>
<span class="sd">    :return:      None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span><span class="p">,</span><span class="n">T</span> <span class="o">=</span> <span class="n">erp</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ts</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">c_lim_style</span> <span class="o">==</span> <span class="s1">&#39;diverge&#39;</span><span class="p">:</span>
        <span class="n">scale_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">erp</span><span class="p">))</span>
        <span class="n">center_signal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">c_min</span> <span class="o">=</span> <span class="o">-</span><span class="n">scale_signal</span>
        <span class="n">c_max</span> <span class="o">=</span> <span class="o">+</span><span class="n">scale_signal</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scale_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">erp</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">erp</span><span class="p">)</span>
        <span class="n">center_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">erp</span><span class="p">)</span>
        <span class="n">c_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">erp</span><span class="p">)</span>
        <span class="n">c_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">erp</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">tf_inverse_color</span><span class="p">:</span>
        <span class="n">erp_plot</span> <span class="o">=</span> <span class="o">-</span><span class="n">erp</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">erp_plot</span> <span class="o">=</span> <span class="n">erp</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">center2edge</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">center2edge</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)),</span> <span class="n">erp_plot</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">c_min</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">c_max</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="p">(</span> <span class="o">-</span><span class="p">(</span><span class="n">erp</span><span class="o">-</span><span class="n">center_signal</span><span class="p">)</span><span class="o">/</span><span class="n">scale_signal</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">trace_scale</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>  <span class="c1"># add &quot;-&quot; because we later invert y axis</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="c1"># ax.set_ylim(sorted(ax.get_ylim(), reverse=True))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">N</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">])</span></div>


<div class="viewcode-block" id="ErpPlot"><a class="viewcode-back" href="../index.html#PyNeuroPlot.ErpPlot">[docs]</a><span class="k">def</span> <span class="nf">ErpPlot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">array_layout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depth_linear</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;ERP&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ERP (event-evoked potential) plot</span>

<span class="sd">    :param array_erp:     a 2d numpy array ( N_chan * N_timepoints ) or the original data object</span>
<span class="sd">    :param ts:            a 1d numpy array ( N_timepoints )</span>
<span class="sd">    :param array_layout:  electrode array layout:</span>

<span class="sd">                          * if None, assume linear layout,</span>
<span class="sd">                          * otherwise, use the the give array_layout in the format: {chan: (row, col)}</span>
<span class="sd">    :param depth_linear:   a list of depth</span>
<span class="sd">    :return:              figure handle</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">array_erp</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">ch_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">array_erp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">array_erp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;signal_info&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;spiketrains&#39;</span><span class="p">:</span>
            <span class="n">ch_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;signal_info&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;signal_info&#39;</span><span class="p">]))]</span>
        <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;signal_info&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;analogsignals&#39;</span><span class="p">:</span>
            <span class="n">ch_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;signal_info&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;signal_info&#39;</span><span class="p">]))]</span>
    <span class="p">[</span><span class="n">N_chan</span><span class="p">,</span> <span class="n">N_ts</span><span class="p">]</span> <span class="o">=</span> <span class="n">array_erp</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N_ts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">array_layout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>                <span class="c1"># if None, assumes linear layout</span>
        <span class="n">offset_plot_chan</span> <span class="o">=</span> <span class="p">(</span><span class="n">array_erp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">array_erp</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="mi">5</span>

        <span class="k">if</span> <span class="n">depth_linear</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">depth_linear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">array_erp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">offset_plot_chan</span>
            <span class="n">array_erp_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">array_erp</span> <span class="o">-</span> <span class="n">depth_linear</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">depth_linear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">depth_linear</span><span class="p">)</span>
            <span class="n">depth_scale</span> <span class="o">=</span> <span class="n">depth_linear</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">depth_linear</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">depth_scale</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">9</span><span class="p">):</span>
                <span class="n">depth_scale</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">depth_linear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">depth_linear</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">array_erp_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">array_erp</span> <span class="o">/</span> <span class="n">offset_plot_chan</span> <span class="o">/</span><span class="mf">15.0</span> <span class="o">*</span> <span class="n">depth_scale</span> <span class="o">-</span> <span class="n">depth_linear</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

        <span class="n">name_colormap</span> <span class="o">=</span> <span class="s1">&#39;rainbow&#39;</span>
        <span class="n">cycle_color</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">name_colormap</span><span class="p">)(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N_chan</span><span class="p">))</span>

        <span class="n">h_fig</span><span class="p">,</span> <span class="n">h_axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">h_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_chan</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">array_erp_offset</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">cycle_color</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1"># for differenet versions of matploblib</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">h_axes_top</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">([</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">h_axes_top</span><span class="o">.</span><span class="n">set_axis_bgcolor</span><span class="p">([</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># plt.ylim( -(N_chan+2)*offset_plot_chan, -(0-3)*offset_plot_chan,  )</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time from event onset (s)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Voltage (V)&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">h_axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">center2edge</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">center2edge</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N_chan</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array_erp</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">))</span>
        <span class="n">color_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array_erp</span><span class="p">)))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="o">-</span><span class="n">color_max</span><span class="p">,</span> <span class="n">color_max</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span> <span class="n">center2edge</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N_chan</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center2edge</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N_chan</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time from event onset (s)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;channel index&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>                                 <span class="c1"># use customized 2D layout, e.g. GM32 array</span>
        <span class="n">text_props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="p">[</span><span class="n">h_fig</span><span class="p">,</span> <span class="n">h_axes</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_array_layout_subplots</span><span class="p">(</span><span class="n">array_layout</span><span class="p">,</span> <span class="n">tf_linear_indx</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">h_fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
        <span class="n">h_fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span><span class="n">forward</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_chan</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">h_axes</span><span class="p">[</span><span class="n">array_layout</span><span class="p">[</span><span class="n">ch_list</span><span class="p">[</span><span class="n">ch</span><span class="p">]]])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">array_erp</span><span class="p">[</span><span class="n">ch</span><span class="p">,</span> <span class="p">:],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="s1">&#39;C</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ch_list</span><span class="p">[</span><span class="n">ch</span><span class="p">]),</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">text_props</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># axis appearance</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">h_axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>  <span class="c1"># for differenet versions of matploblib</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">h_axes_top</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">h_axes_top</span><span class="o">.</span><span class="n">set_axis_bgcolor</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="n">ax_bottomleft</span> <span class="o">=</span> <span class="n">h_axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">ax_bottomleft</span><span class="p">)</span>
            <span class="n">ax_bottomleft</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax_bottomleft</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax_bottomleft</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
            <span class="n">ax_bottomleft</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Voltage&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">ylim_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ax_bottomleft</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()))</span>
            <span class="n">ax_bottomleft</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="n">ylim_max</span><span class="p">,</span> <span class="n">ylim_max</span><span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">h_fig</span><span class="p">,</span> <span class="n">h_axes</span></div>


<div class="viewcode-block" id="RfPlot"><a class="viewcode-back" href="../index.html#PyNeuroPlot.RfPlot">[docs]</a><span class="k">def</span> <span class="nf">RfPlot</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">,</span> <span class="n">indx_sgnl</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_focus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tf_scr_ctr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
           <span class="n">psth_overlay</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">t_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fr_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sk_std</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    plot RF using one single plot</span>

<span class="sd">    :param data_neuro:  the data_neuro[&#39;cdtn&#39;] contains &#39;x&#39; and &#39;y&#39;, which represents the location of stimulus</span>
<span class="sd">    :param indx_sgnl:   index of signal, i.e. the data_neuro[&#39;cdtn&#39;][:,:,indx_sgnl] would be used for plotting</span>
<span class="sd">    :param data:        if not None, use the data instead of data_neuro[&#39;data&#39;][:,:,indx_sgnl], a 2D array of shape [N_trials, N_ts]</span>
<span class="sd">    :param t_focus:     duration of time used to plot heatmap, e.g. [0.050, 0.200]</span>
<span class="sd">    :param tf_scr_ctr:  True/False, plot [0.0] point of screen</span>
<span class="sd">    :param psth_overlay:True/False overlay psth</span>
<span class="sd">    :param t_scale:     for psth overlay, duration of time (ts) to be mapped to unit 1 of space</span>
<span class="sd">    :param fr_scale:    for psth overlay, scale for firing rate</span>
<span class="sd">    :param sk_std:      smooth kernel standard deviation, e.g. 0.005, for 5ms</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][:,:,</span><span class="n">indx_sgnl</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">indx_sgnl</span><span class="p">]</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">sk_std</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pna</span><span class="o">.</span><span class="n">SmoothTrace</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">sk_std</span><span class="o">=</span><span class="n">sk_std</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="n">ts</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">t_focus</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t_focus</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

    <span class="c1"># get x and y values</span>
    <span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;cdtn&#39;</span><span class="p">])[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;cdtn&#39;</span><span class="p">])[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">x_spacing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x_grid</span><span class="p">))</span>
    <span class="n">y_spacing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">y_grid</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">t_scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t_scale</span> <span class="o">=</span> <span class="p">(</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span><span class="o">/</span><span class="n">x_spacing</span><span class="o">*</span><span class="mf">1.1</span>

    <span class="n">fr_2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x_grid</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">y_grid</span><span class="p">)])</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;cdtn&#39;</span><span class="p">]):</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">xy</span>
        <span class="n">i_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">x_grid</span> <span class="o">==</span> <span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">i_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">y_grid</span> <span class="o">==</span> <span class="n">y</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fr_2D</span><span class="p">[</span><span class="n">i_x</span><span class="p">,</span> <span class="n">i_y</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">data</span><span class="p">[</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;cdtn_indx&#39;</span><span class="p">][</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;cdtn&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">ts</span><span class="o">&gt;=</span><span class="n">t_focus</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ts</span><span class="o">&lt;</span><span class="n">t_focus</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">])</span>

    <span class="k">if</span> <span class="n">fr_scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fr_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">fr_2D</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_spacing</span> <span class="o">*</span><span class="mi">2</span>

    <span class="k">if</span> <span class="n">psth_overlay</span><span class="p">:</span>
        <span class="c1"># plt.figure()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;signal_info&#39;</span><span class="p">][</span><span class="n">indx_sgnl</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span> <span class="n">center2edge</span><span class="p">(</span><span class="n">x_grid</span><span class="p">),</span> <span class="n">center2edge</span><span class="p">(</span><span class="n">y_grid</span><span class="p">),</span> <span class="n">fr_2D</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;cdtn&#39;</span><span class="p">]):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_spacing</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">ts</span><span class="o">-</span><span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">t_scale</span><span class="p">,</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_spacing</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                             <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_spacing</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">data</span><span class="p">[</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;cdtn_indx&#39;</span><span class="p">][</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;cdtn&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]],</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">fr_scale</span><span class="p">,</span>
                             <span class="n">color</span><span class="o">=</span><span class="s1">&#39;deepskyblue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="c1"># plt.fill_between( xy[0]+np.array(data_neuro[&#39;ts&#39;])/t_scale, xy[1], xy[1]+np.mean( data_neuro[&#39;data&#39;][ data_neuro[&#39;cdtn_indx&#39;][data_neuro[&#39;cdtn&#39;][i]] ,:,indx_sgnl], axis=0 )/fr_scale, color=[0,0,0,0.5] )</span>
            <span class="c1"># plt.plot(xy[0],xy[1],&#39;r+&#39;, linewidth=1)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">center2edge</span><span class="p">(</span><span class="n">x_grid</span><span class="p">)[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">center2edge</span><span class="p">(</span><span class="n">y_grid</span><span class="p">)[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">center2edge</span><span class="p">(</span><span class="n">x_grid</span><span class="p">),</span> <span class="n">center2edge</span><span class="p">(</span><span class="n">y_grid</span><span class="p">),</span> <span class="n">fr_2D</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tf_scr_ctr</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;w-&#39;</span><span class="p">,</span> <span class="n">Linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_grid</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="s1">&#39;w-&#39;</span><span class="p">,</span> <span class="n">Linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></div>


<div class="viewcode-block" id="CreateSubplotFromGroupby"><a class="viewcode-back" href="../index.html#PyNeuroPlot.CreateSubplotFromGroupby">[docs]</a><span class="k">def</span> <span class="nf">CreateSubplotFromGroupby</span><span class="p">(</span><span class="n">df_groupby_ord</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tf_title</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    creates subplots according to the structure defined in df_ana.dfGropuby</span>

<span class="sd">    :param df_groupby_ord: dictionary returned by df_ana.dfGroupby,</span>
<span class="sd">                        {&#39;idx&#39;: {group_key: array of trial indexes within group}, &#39;order&#39;: {group_key: order in plot}}</span>
<span class="sd">    :param figsize:   e.g (12, 9)</span>
<span class="sd">    :param tf_title:  True/False to add title</span>
<span class="sd">    :return:          h_fig, h_axes</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_groupby_ord</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;input dictionary can not be empty&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df_groupby_ord</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>  <span class="c1"># input is {str/num: int}, e.g. {&#39;a&#39;: 0, &#39;b&#39;: 1}</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">df_groupby_ord</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">num_r</span><span class="p">,</span> <span class="n">num_c</span> <span class="o">=</span> <span class="n">AutoRowCol</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">h_fig</span><span class="p">,</span> <span class="n">h_axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_r</span><span class="p">,</span> <span class="n">num_c</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">h_axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">h_axes</span><span class="p">)</span>
        <span class="n">h_axes</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">h_axes</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">df_groupby_ord</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">else</span><span class="p">:</span>      <span class="c1"># input is {tuple_of_cdtn: tuple_of_order}, e.g. {(&#39;a&#39;,1): (0,0), (&#39;b&#39;,1): (1,1)}</span>
        <span class="n">Ns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">df_groupby_ord</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ns</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">h_fig</span><span class="p">,</span> <span class="n">h_axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">Ns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">h_axes</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">h_axes</span><span class="p">[</span><span class="n">val</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">df_groupby_ord</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ns</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">h_fig</span><span class="p">,</span> <span class="n">h_axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">Ns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Ns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">h_axes</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">h_axes</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">df_groupby_ord</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;val can not be more than two dimensions in input {key: val}&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tf_title</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">h_axes</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">h_axes</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">h_fig</span><span class="p">,</span> <span class="n">h_axes</span></div>


<div class="viewcode-block" id="PlotDataFromGroup"><a class="viewcode-back" href="../index.html#PyNeuroPlot.PlotDataFromGroup">[docs]</a><span class="k">def</span> <span class="nf">PlotDataFromGroup</span><span class="p">(</span><span class="n">cdtn</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">plotfun</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;cdtn&#39;</span> <span class="ow">in</span> <span class="n">cdtn</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>   <span class="c1"># if input cdtn is data_neuro</span>
        <span class="n">cdtn</span> <span class="o">=</span> <span class="n">cdtn</span><span class="p">[</span><span class="s1">&#39;cdtn&#39;</span><span class="p">]</span>

    <span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">isSingle</span><span class="p">(</span><span class="n">cdtn</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>            <span class="c1"># if cdtn is 1D, automatically decide row and column</span>
        <span class="n">N_cdtn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cdtn</span><span class="p">)</span>
        <span class="p">[</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">AutoRowCol</span><span class="p">(</span><span class="n">N_cdtn</span><span class="p">)</span>
        <span class="p">[</span><span class="n">h_fig</span><span class="p">,</span> <span class="n">h_ax</span><span class="p">]</span><span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>      <span class="c1"># creates subplots</span>
        <span class="n">h_ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">h_ax</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cdtn_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cdtn</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">h_ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">plotfun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>    <span class="c1"># in each panel, plot</span>
                <span class="n">plotfun</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">cdtn_i</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cdtn</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>            <span class="c1"># if cdtn is 2D,  use dim10 as rows and dim1 as columns</span>
        <span class="p">[</span><span class="n">cdtn0</span><span class="p">,</span> <span class="n">cdtn1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span> <span class="o">*</span><span class="n">cdtn</span> <span class="p">)</span>
        <span class="n">cdtn0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cdtn0</span><span class="p">))</span>
        <span class="n">cdtn1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cdtn1</span><span class="p">))</span>
        <span class="n">n_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cdtn0</span><span class="p">)</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cdtn1</span><span class="p">)</span>
        <span class="p">[</span><span class="n">h_fig</span><span class="p">,</span> <span class="n">h_ax</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>    <span class="c1"># creates subplots</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cdtn_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cdtn</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">cdtn0</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cdtn_i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">cdtn1</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cdtn_i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">h_ax</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">plotfun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>    <span class="c1"># in each panel, plot</span>
                <span class="n">plotfun</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">cdtn_i</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>                                          <span class="c1"># if cdtn is more than 2D, raise exception</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;cdtn structure does not meet the requirement of PlotDataFromGroup&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">c_lim</span> <span class="o">=</span> <span class="n">share_clim</span><span class="p">(</span><span class="n">h_ax</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;share clim was not successful&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">h_fig</span><span class="p">,</span> <span class="n">h_ax</span><span class="p">]</span></div>



<div class="viewcode-block" id="SmartSubplot"><a class="viewcode-back" href="../index.html#PyNeuroPlot.SmartSubplot">[docs]</a><span class="k">def</span> <span class="nf">SmartSubplot</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">,</span> <span class="n">functionPlot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dataPlot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suptitle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tf_colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Smart subplots based on the data_neuro[&#39;cdtn&#39;]</span>

<span class="sd">    in each panel, plot using function &#39;functionPlot&#39;, on data &#39;dataPlot&#39;;</span>
<span class="sd">    if cdtn is 1D, automatically decide row and column; if 2D, use dim0 as rows and dim1 as columns</span>
<span class="sd">    :param data_neuro:    dictionary containing field &#39;cdtn&#39; and &#39;cdtn_indx&#39;, which directing the subplot layout</span>
<span class="sd">    :param functionPlot:  the plot function in each panel</span>
<span class="sd">    :param dataPlot:      the data that plot function applies on; in each panel, its first dim is sliced using data_neuro[&#39;cdtn_indx&#39;], if None, use data_neuro[data]</span>
<span class="sd">    :return:              [h_fig, h_ax]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;cdtn&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_neuro</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>            <span class="c1"># if the input data does not contain the field for sorting</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;data does not contain fields &quot;cdtn&quot; for subplot&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">data_neuro</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="n">dataPlot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># if dataPlot is None, use data_neuro[data]</span>
        <span class="n">dataPlot</span> <span class="o">=</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">isSingle</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;cdtn&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>            <span class="c1"># if cdtn is 1D, automatically decide row and column</span>
        <span class="n">N_cdtn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;cdtn&#39;</span><span class="p">])</span>
        <span class="p">[</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">AutoRowCol</span><span class="p">(</span><span class="n">N_cdtn</span><span class="p">)</span>
        <span class="p">[</span><span class="n">h_fig</span><span class="p">,</span> <span class="n">h_ax</span><span class="p">]</span><span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>      <span class="c1"># creates subplots</span>
        <span class="n">h_ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">h_ax</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cdtn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;cdtn&#39;</span><span class="p">]):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">h_ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">functionPlot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dataPlot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>    <span class="c1"># in each panel, plot</span>
                <span class="n">functionPlot</span><span class="p">(</span><span class="n">dataPlot</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;cdtn_indx&#39;</span><span class="p">][</span><span class="n">cdtn</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">cdtn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;cdtn&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>            <span class="c1"># if cdtn is 2D,  use dim10 as rows and dim1 as columns</span>
        <span class="p">[</span><span class="n">cdtn0</span><span class="p">,</span> <span class="n">cdtn1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span> <span class="o">*</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;cdtn&#39;</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">cdtn0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cdtn0</span><span class="p">))</span>
        <span class="n">cdtn1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cdtn1</span><span class="p">))</span>
        <span class="n">n_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cdtn0</span><span class="p">)</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cdtn1</span><span class="p">)</span>
        <span class="p">[</span><span class="n">h_fig</span><span class="p">,</span> <span class="n">h_ax</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    <span class="c1"># creates subplots</span>
        <span class="k">for</span> <span class="n">cdtn</span> <span class="ow">in</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;cdtn&#39;</span><span class="p">]:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">cdtn0</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cdtn</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">cdtn1</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cdtn</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">h_ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">functionPlot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dataPlot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>    <span class="c1"># in each panel, plot</span>
                <span class="n">functionPlot</span><span class="p">(</span><span class="n">dataPlot</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;cdtn_indx&#39;</span><span class="p">][</span><span class="n">cdtn</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">cdtn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>                                          <span class="c1"># if cdtn is more than 2D, raise exception</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;cdtn structure does not meet the requirement of SmartSubplot&#39;</span><span class="p">)</span>

    <span class="n">h_fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span><span class="mi">9</span><span class="p">],</span> <span class="n">forward</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">suptitle</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;grpby&#39;</span><span class="p">]</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="c1"># share clim across axes</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">c_lim</span> <span class="o">=</span> <span class="n">share_clim</span><span class="p">(</span><span class="n">h_ax</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;share clim was not successful&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tf_colorbar</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">h_fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">gci</span><span class="p">(),</span> <span class="n">ax</span><span class="o">=</span><span class="n">h_ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;can not create colorbar&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">h_fig</span><span class="p">,</span> <span class="n">h_ax</span><span class="p">]</span></div>


<div class="viewcode-block" id="PsthPlot"><a class="viewcode-back" href="../index.html#PyNeuroPlot.PsthPlot">[docs]</a><span class="k">def</span> <span class="nf">PsthPlot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cdtn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sk_std</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subpanel</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">color_style</span><span class="o">=</span><span class="s1">&#39;discrete&#39;</span><span class="p">,</span>
             <span class="n">tf_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    funciton to plot psth with a raster panel on top of PSTH, works for both spike data and LFP data</span>

<span class="sd">    :param data:        neuro data, np array of various size and dtpye:</span>
<span class="sd">                            size: 2D [N_trials * N_ts] or 3D [N_trials * N_ts * N_signals]</span>
<span class="sd">                            dtype: boolean (spike exist or not) or float (LFP continuous values)</span>
<span class="sd">    :param ts:          1D array containing timestamps for data (length is N_ts)</span>
<span class="sd">    :param cdtn:        conditions used to group</span>
<span class="sd">                            if data is 2D, represent the type of trials,  len(cdtn)=N_ts</span>
<span class="sd">                            if data is 3D, represent the type of signals, len(cdtn)=N_signals</span>
<span class="sd">    :param limit:       index array to select a subset of the trials of data, i.e., data=data[limit,:]</span>
<span class="sd">    :param sk_std:      std of gaussian smoothness kernel, applied along time axis, default to None</span>
<span class="sd">    :param subpanel:    types of sub-panel on tops of PSTH, default to &#39;auto&#39;:</span>

<span class="sd">                        * if &#39;spk&#39;  : data2D is boolean, where every True value represents a spike, plot line raster</span>
<span class="sd">                        * if &#39;LFP&#39;  : data2D is continuous float, plot pcolormesh</span>
<span class="sd">                        * if &#39;auto&#39; : use data format to decide which plot to use</span>
<span class="sd">                        * if &#39;&#39;     : does not create subpanel</span>
<span class="sd">    :param color_style: &#39;discrete&#39; or &#39;continuous&#39;</span>
<span class="sd">    :param tf_legend:   boolean, true/false to plot legend</span>
<span class="sd">    :param x_label:     string</span>
<span class="sd">    :param y_label:     string</span>
<span class="sd">    :param legend_title:None or string</span>
<span class="sd">    :return:            axes of plot: [ax_psth, ax_raster]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="sd">&quot;&quot;&quot; ----- process the input, to work with various inputs ----- &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>       <span class="c1"># select trials of interest</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">limit</span><span class="p">]</span>

    <span class="n">cdtn_unq</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>     <span class="c1"># if data is 3D [N_trials * N_ts * N_signals]</span>
        <span class="p">[</span><span class="n">N</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">S</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">data2D</span> <span class="o">=</span> <span class="n">signal_align</span><span class="o">.</span><span class="n">data3Dto2D</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>   <span class="c1"># re-organize as 2D [(N_trials* N_signals) * N_ts ]</span>
        <span class="k">if</span> <span class="n">cdtn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>                         <span class="c1"># condition is the tag of the last dimension (e.g. signal name)</span>
            <span class="n">cdtn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">N</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">S</span><span class="p">)])</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cdtn</span><span class="p">)</span> <span class="o">==</span> <span class="n">S</span><span class="p">:</span>
            <span class="n">cdtn_unq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cdtn</span><span class="p">)</span>
            <span class="n">cdtn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">N</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cdtn</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cdtn</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">S</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;cdtn length does not match the number of signals in data&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>   <span class="c1"># if data is 2D [N_trials * N_ts]</span>
        <span class="n">data2D</span> <span class="o">=</span> <span class="n">data</span>
        <span class="p">[</span><span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">data2D</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cdtn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>                         <span class="c1"># condition is the tag of the trials</span>
            <span class="n">cdtn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cdtn</span> <span class="o">=</span> <span class="n">cdtn</span><span class="p">[</span><span class="n">limit</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span><span class="p">(</span><span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;input data does not have the right dimension&#39;</span><span class="p">))</span>

    <span class="n">cdtn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cdtn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cdtn_unq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cdtn_unq</span> <span class="o">=</span> <span class="n">get_unique_elements</span><span class="p">(</span><span class="n">cdtn</span><span class="p">)</span>        <span class="c1"># unique conditions</span>
    <span class="n">M</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cdtn_unq</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">data2D</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>

    <span class="sd">&quot;&quot;&quot; ----- calculate PSTH for every condition ----- &quot;&quot;&quot;</span>
    <span class="n">ax_psth</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">psth_cdtn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">M</span><span class="p">,</span> <span class="n">T</span><span class="p">])</span>
    <span class="n">N_cdtn</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">M</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">N_cdtn_cum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">M</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">cdtn_k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cdtn_unq</span><span class="p">):</span>
        <span class="n">N_cdtn</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cdtn</span><span class="o">==</span><span class="n">cdtn_k</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">N_cdtn</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">psth_cdtn</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">psth_cdtn</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psth_cdtn</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data2D</span><span class="p">[</span><span class="n">cdtn</span><span class="o">==</span><span class="n">cdtn_k</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">N_cdtn_cum</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">N_cdtn</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sk_std</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># condition for using smoothness kernel</span>
        <span class="n">ts_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># get sampling interval</span>
        <span class="n">kernel_std</span> <span class="o">=</span> <span class="n">sk_std</span> <span class="o">/</span> <span class="n">ts_interval</span>  <span class="c1"># std in frames</span>
        <span class="n">kernel_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">kernel_std</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># num of frames, 3*std on each side, an odd number</span>
        <span class="n">smooth_kernel</span> <span class="o">=</span> <span class="n">sgn</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="n">kernel_len</span><span class="p">,</span> <span class="n">kernel_std</span><span class="p">)</span>
        <span class="n">smooth_kernel</span> <span class="o">=</span> <span class="n">smooth_kernel</span> <span class="o">/</span> <span class="n">smooth_kernel</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># normalized smooth kernel</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
            <span class="n">psth_cdtn</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">psth_cdtn</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:],</span> <span class="n">smooth_kernel</span><span class="p">,</span> <span class="s1">&#39;same&#39;</span><span class="p">)</span>

    <span class="n">colors</span> <span class="o">=</span> <span class="n">gen_distinct_colors</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">luminance</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">color_style</span><span class="p">)</span>

    <span class="sd">&quot;&quot;&quot; ========== plot psth ========== &quot;&quot;&quot;</span>
    <span class="n">hl_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">cdtn_k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cdtn_unq</span><span class="p">):</span>
        <span class="n">hl_line</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">psth_cdtn</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:],</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">hl_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hl_line</span><span class="p">)</span>

    <span class="n">textprops</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;wheat&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="s1">&#39;N=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax_psth</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
             <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-small&#39;</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">textprops</span><span class="p">)</span>

    <span class="n">ax_psth</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">if</span> <span class="n">tf_legend</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">cdtn_unq</span><span class="p">,</span> <span class="n">labelspacing</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">},</span>
                   <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">legend_title</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xlabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>

    <span class="sd">&quot;&quot;&quot; ========== plot a subpanel, either rasters or LFP pcolor ========== &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">subpanel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="c1"># ========== sub-panel for raster or p-color  ==========</span>
        <span class="n">ax_raster</span> <span class="o">=</span> <span class="n">add_axes_on_top</span><span class="p">(</span><span class="n">ax_psth</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">ax_raster</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">subpanel</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>      <span class="c1"># if auto, use the data features to determine raster (spk) plot or pcolor (LFP) plot</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data2D</span><span class="p">))</span> <span class="o">&lt;=</span><span class="mi">20</span><span class="p">:</span>
                <span class="n">subpanel</span> <span class="o">=</span> <span class="s1">&#39;spk&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subpanel</span> <span class="o">=</span> <span class="s1">&#39;LFP&#39;</span>

        <span class="k">if</span> <span class="n">subpanel</span> <span class="ow">is</span> <span class="s1">&#39;spk&#39;</span><span class="p">:</span>       <span class="c1"># ---------- plot raster (spike trains) ----------</span>
            <span class="n">RasterPlot</span><span class="p">(</span><span class="n">data2D</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="n">ts</span><span class="p">,</span> <span class="n">cdtn</span><span class="o">=</span><span class="n">cdtn</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">max_rows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">RasterType</span><span class="o">=</span><span class="n">subpanel</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">subpanel</span> <span class="ow">is</span> <span class="s1">&#39;LFP&#39;</span><span class="p">:</span>     <span class="c1"># ---------- plot_pcolor (LFP) ----------</span>
            <span class="n">RasterPlot</span><span class="p">(</span><span class="n">data2D</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="n">ts</span><span class="p">,</span> <span class="n">cdtn</span><span class="o">=</span><span class="n">cdtn</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">max_rows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">RasterType</span><span class="o">=</span><span class="n">subpanel</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax_raster</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax_raster</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">ax_psth</span><span class="p">,</span> <span class="n">ax_raster</span><span class="p">]</span></div>


<div class="viewcode-block" id="PsthPlotMultiPanel"><a class="viewcode-back" href="../index.html#PyNeuroPlot.PsthPlotMultiPanel">[docs]</a><span class="k">def</span> <span class="nf">PsthPlotMultiPanel</span><span class="p">(</span><span class="n">data_neuro</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index_signal</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                       <span class="n">data2D</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groupby_subplots</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">aggregate_subplots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">linearize_subplots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">groupby_panel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sk_std</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subpanel</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">color_style</span><span class="o">=</span><span class="s1">&#39;discrete&#39;</span><span class="p">,</span>
                       <span class="n">tf_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="n">signal_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    plot PSTH in multiple subplots grouped by experimental conditions, a wrapper function of</span>
<span class="sd">    pnp.PsthPlot, pnp.CreateSubplotFromGroupby and df_ana.DfGroupby,</span>
<span class="sd">    data either provided by (data_neuro, index_signal) or (data2D, ts, data_df), the later one offers more control</span>

<span class="sd">    :param data_neuro:   standard data_neuro structure, retured by signal_align.blk.align_to_event()</span>
<span class="sd">    :param index_signal: index of signal used to select data_neuro[&#39;data&#39;][:, :, index_signal]</span>
<span class="sd">    :param data2D:       neural data of one signal/channel,  shape=[N_trials * N_ts]</span>
<span class="sd">    :param ts:           1D array containing timestamps for data (length is N_ts)</span>
<span class="sd">    :param data_df:      pandas data frame of trial-related information, with num_rows=N_trials</span>
<span class="sd">    :param limit:        index array or boolean array, used to filter the trials that goes in the plot,</span>
<span class="sd">                            e.g. np.random.rand(N_trials)&gt;0.5 or data_df[&#39;reaction_time&#39;]&lt;500</span>
<span class="sd">    :param groupby_subplots:   column name(s) of data_df used to group data into subplots, either a str or a list of strings</span>
<span class="sd">    :param aggregate_subplots: True/False to add a aggregation group (not grouped) for every column</span>
<span class="sd">    :param linearize_subplots: column name of data_df used to group data within each panel</span>
<span class="sd">    :param groupby_panel:      column name of data_df used to group data within each panel</span>
<span class="sd">    :param sk_std:       std of gaussian smoothness kernel, applied along time axis, default to None</span>
<span class="sd">    :param subpanel:     types of sub-panel on tops of PSTH, default to &#39;auto&#39;</span>
<span class="sd">    :param color_style:  &#39;discrete&#39; or &#39;continuous&#39;</span>
<span class="sd">    :param tf_legend:    boolean, true/false to plot legend</span>
<span class="sd">    :param xlabel:       string</span>
<span class="sd">    :param ylabel:       string</span>
<span class="sd">    :param figsize:      e.g. (12, 9)</span>
<span class="sd">    :param signal_name:  name of the signal to plot, shown in suptitle</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">data_neuro</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data2D</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data2D</span> <span class="o">=</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">index_signal</span><span class="p">]</span>
            <span class="n">signal_name</span> <span class="o">=</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;signal_info&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">][</span><span class="n">index_signal</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">data_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_df</span> <span class="o">=</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;trial_info&#39;</span><span class="p">]</span>


    <span class="n">df_grpby</span> <span class="o">=</span> <span class="n">df_ana</span><span class="o">.</span><span class="n">DfGroupby</span><span class="p">(</span><span class="n">data_df</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="n">groupby_subplots</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
                                <span class="n">tf_aggregate</span><span class="o">=</span><span class="n">aggregate_subplots</span><span class="p">,</span> <span class="n">tf_linearize</span><span class="o">=</span><span class="n">linearize_subplots</span><span class="p">)</span>
    <span class="n">h_fig</span><span class="p">,</span> <span class="n">h_axes</span> <span class="o">=</span> <span class="n">CreateSubplotFromGroupby</span><span class="p">(</span><span class="n">df_grpby</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">],</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cdtn</span> <span class="ow">in</span> <span class="n">df_grpby</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">h_axes</span><span class="p">[</span><span class="n">cdtn</span><span class="p">])</span>
        <span class="n">idx_trials</span> <span class="o">=</span> <span class="n">df_grpby</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">][</span><span class="n">cdtn</span><span class="p">]</span>
        <span class="n">PsthPlot</span><span class="p">(</span><span class="n">data2D</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="n">ts</span><span class="p">,</span> <span class="n">cdtn</span><span class="o">=</span><span class="n">data_df</span><span class="p">[</span><span class="n">groupby_panel</span><span class="p">],</span> <span class="n">limit</span><span class="o">=</span><span class="n">idx_trials</span><span class="p">,</span>
                 <span class="n">sk_std</span><span class="o">=</span><span class="n">sk_std</span><span class="p">,</span> <span class="n">subpanel</span><span class="o">=</span><span class="n">subpanel</span><span class="p">,</span> <span class="n">color_style</span><span class="o">=</span><span class="n">color_style</span><span class="p">,</span>
                 <span class="n">tf_legend</span><span class="o">=</span><span class="n">tf_legend</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">legend_title</span><span class="o">=</span><span class="n">groupby_panel</span><span class="p">,</span>
                 <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">cdtn</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, grouped by </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">signal_name</span><span class="p">,</span> <span class="n">groupby_subplots</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">h_fig</span><span class="p">,</span> <span class="n">h_axes</span></div>


<div class="viewcode-block" id="RasterPlot"><a class="viewcode-back" href="../index.html#PyNeuroPlot.RasterPlot">[docs]</a><span class="k">def</span> <span class="nf">RasterPlot</span><span class="p">(</span><span class="n">data2D</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cdtn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">RasterType</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">max_rows</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Spike/LFP raster Plot, where evary row presresent one trial, sorted by cdtn</span>

<span class="sd">    :param data2D:   2D np.array of boolean/float values, [N_trial * N_ts]</span>
<span class="sd">    :param ts:       1D np.array of timestamps, 1D np.array of length N_ts,    used as x axis for plot</span>
<span class="sd">    :param cdtn:     condition of every trial,  1D np.array of length N_trial, used to sort trials</span>
<span class="sd">    :param colors:   a list of colors for every unique condition</span>
<span class="sd">    :param RasterType:    string, &#39;spk&#39;, &#39;LFP&#39; or &#39;auto&#39;, default to &#39;auto&#39;:</span>

<span class="sd">                     * if &#39;spk&#39;  : data2D is boolean, where every True value represents a spike, plot line raster</span>
<span class="sd">                     * if &#39;LFP&#39;  : data2D is continuous float, plot pcolormesh</span>
<span class="sd">                     * if &#39;auto&#39; : use data2D format to decide which plot to use</span>
<span class="sd">    :return:         handle of raster plot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data2D</span><span class="p">)</span>
    <span class="p">[</span><span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">]</span> <span class="o">=</span> <span class="n">data2D</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="n">cdtn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>        <span class="c1"># if cdtn is none, fill with blank string</span>
        <span class="n">cdtn</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">N</span>

    <span class="c1"># reorder index according to cdtn, so that trials of the same condition sits together in rows</span>
    <span class="n">cdtn_unq</span> <span class="o">=</span> <span class="n">get_unique_elements</span><span class="p">(</span><span class="n">cdtn</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cdtn_unq</span><span class="p">)</span>
    <span class="n">cdtn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cdtn</span><span class="p">)</span>
    <span class="n">index_reorder</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">cdtn</span> <span class="o">==</span> <span class="n">cdtn_k</span><span class="p">)</span> <span class="k">for</span> <span class="n">cdtn_k</span> <span class="ow">in</span> <span class="n">cdtn_unq</span><span class="p">])</span>
    <span class="n">data2D</span> <span class="o">=</span> <span class="n">data2D</span><span class="p">[</span><span class="n">index_reorder</span><span class="p">,:]</span>
    <span class="n">cdtn</span> <span class="o">=</span> <span class="n">cdtn</span><span class="p">[</span><span class="n">index_reorder</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>      <span class="c1"># if no color is given</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">gen_distinct_colors</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">luminance</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># if N is too large, to speed up plot, randomly select a fraction to plot</span>
    <span class="k">if</span> <span class="n">max_rows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">max_rows</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">:</span>
            <span class="n">indx_subselect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">max_rows</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="n">data2D</span> <span class="o">=</span> <span class="n">data2D</span><span class="p">[</span><span class="n">indx_subselect</span><span class="p">,:]</span>
            <span class="n">cdtn</span>   <span class="o">=</span> <span class="n">cdtn</span><span class="p">[</span><span class="n">indx_subselect</span><span class="p">]</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">max_rows</span>

    <span class="k">if</span> <span class="n">RasterType</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data2D</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">RasterType</span> <span class="o">=</span> <span class="s1">&#39;spk&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">RasterType</span> <span class="o">=</span> <span class="s1">&#39;LFP&#39;</span>

    <span class="c1"># color for every raster line</span>
    <span class="n">cdtn_indx_of_trial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">N_cdtn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">M</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">cdtn_k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cdtn_unq</span><span class="p">):</span>
        <span class="n">N_cdtn</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cdtn</span> <span class="o">==</span> <span class="n">cdtn_k</span><span class="p">)</span>
        <span class="n">cdtn_indx_of_trial</span><span class="p">[</span><span class="n">cdtn</span> <span class="o">==</span> <span class="n">cdtn_k</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
    <span class="n">N_cdtn_cum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">N_cdtn</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">RasterType</span> <span class="o">==</span> <span class="s1">&#39;spk&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data2D</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">data2D</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">x_ts</span>  <span class="o">=</span> <span class="n">ts</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>   <span class="c1"># x loc of raster lines</span>
            <span class="n">y</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>       <span class="c1"># y loc of raster lines</span>
            <span class="n">y_min</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="mf">0.0005</span><span class="o">*</span><span class="n">N</span>
            <span class="n">y_max</span> <span class="o">=</span> <span class="n">y</span><span class="o">+</span><span class="mi">1</span> <span class="o">+</span><span class="mf">0.0005</span><span class="o">*</span><span class="n">N</span>

            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">colors</span><span class="p">)[</span> <span class="n">cdtn_indx_of_trial</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)]</span> <span class="p">]</span>

            <span class="c1"># ----- major plot commmand -----</span>
            <span class="n">h_raster</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x_ts</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h_raster</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">([],</span> <span class="p">[],</span> <span class="p">[])</span>

    <span class="k">elif</span> <span class="n">RasterType</span> <span class="o">==</span> <span class="s1">&#39;LFP&#39;</span><span class="p">:</span>
        <span class="c1"># -----  major plot command -----</span>
        <span class="c1"># c_axis_abs = np.max(np.abs(data2D))</span>
        <span class="n">c_axis_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data2D</span><span class="p">),</span> <span class="mi">98</span><span class="p">)</span>
        <span class="n">h_raster</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">center2edge</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">data2D</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="n">c_axis_abs</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">c_axis_abs</span><span class="p">,</span>
                       <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">))</span>

        <span class="c1"># a colored line segment illustrating the conditions</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cdtn</span><span class="p">))</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">ts</span><span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">M</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">N_cdtn_cum</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="n">M</span><span class="p">],</span> <span class="n">N_cdtn_cum</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;wrong RasterType, must by either &quot;spk&quot; or &quot;LFP&quot; &#39;</span><span class="p">)</span>

    <span class="c1"># horizontal lines deviding difference conditions</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">N_cdtn_cum</span><span class="p">,</span> <span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">keep_less_than</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">N_cdtn_cum</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="mi">8</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-small&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h_raster</span></div>


<div class="viewcode-block" id="DataNeuroSummaryPlot"><a class="viewcode-back" href="../index.html#PyNeuroPlot.DataNeuroSummaryPlot">[docs]</a><span class="k">def</span> <span class="nf">DataNeuroSummaryPlot</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">,</span> <span class="n">sk_std</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">signal_type</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">suptitle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tf_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Summary plot for data_neuro, uses SmartSubplot and PsthPlot</span>

<span class="sd">    Use data_neuro[&#39;cdtn&#39;] to sort and group trials in to sub-panels, plot all signals in every sub-panel</span>

<span class="sd">    :param data_neuro:  data_neuro structure, see moduel signal_align.blk_align_to_evt</span>
<span class="sd">    :param sk_std:      smoothness kernel, if None, set automatically based on data type</span>
<span class="sd">    :param signal_type: &#39;spk&#39;, &#39;LFP&#39; or &#39;auto&#39;</span>
<span class="sd">    :param suptitle:    title of figure</span>
<span class="sd">    :param xlabel:      xlabel</span>
<span class="sd">    :param ylabel:      ylabel</span>
<span class="sd">    :return:            figure handle</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ts</span> <span class="o">=</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">signal_type</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]))</span> <span class="o">&lt;=</span><span class="mi">20</span><span class="p">:</span>   <span class="c1"># signal is spk</span>
            <span class="n">signal_type</span> <span class="o">=</span> <span class="s1">&#39;spk&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">signal_type</span> <span class="o">=</span> <span class="s1">&#39;LFP&#39;</span>           <span class="c1"># signal is LFP</span>

    <span class="k">if</span> <span class="n">sk_std</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">signal_type</span> <span class="o">==</span> <span class="s1">&#39;spk&#39;</span><span class="p">:</span>
            <span class="n">sk_std</span> <span class="o">=</span> <span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">100</span>
    <span class="k">if</span> <span class="n">xlabel</span> <span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;t (s)&#39;</span>
    <span class="k">if</span> <span class="n">ylabel</span> <span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">signal_type</span> <span class="o">==</span> <span class="s1">&#39;spk&#39;</span><span class="p">:</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;firing rate (spk/s)&#39;</span>
        <span class="k">elif</span> <span class="n">signal_type</span> <span class="o">==</span> <span class="s1">&#39;LFP&#39;</span><span class="p">:</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;LFP (V)&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">name_signals</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;signal_info&#39;</span><span class="p">]]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">name_signals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">if</span> <span class="s1">&#39;cdtn&#39;</span> <span class="ow">in</span> <span class="n">data_neuro</span><span class="p">:</span>
        <span class="c1"># plot function for every panel</span>
        <span class="n">functionPlot</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">PsthPlot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="n">ts</span><span class="p">,</span> <span class="n">cdtn</span><span class="o">=</span><span class="n">name_signals</span><span class="p">,</span> <span class="n">sk_std</span><span class="o">=</span><span class="n">sk_std</span><span class="p">,</span> <span class="n">tf_legend</span><span class="o">=</span><span class="n">tf_legend</span><span class="p">,</span>
                                          <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">color_style</span><span class="o">=</span><span class="s1">&#39;continuous&#39;</span><span class="p">)</span>

        <span class="c1"># plot every condition in every panel</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">SmartSubplot</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">,</span> <span class="n">functionPlot</span><span class="p">,</span> <span class="n">suptitle</span><span class="o">=</span><span class="n">suptitle</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">PsthPlot</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">ts</span><span class="o">=</span><span class="n">ts</span><span class="p">,</span> <span class="n">cdtn</span><span class="o">=</span><span class="n">name_signals</span><span class="p">,</span> <span class="n">sk_std</span><span class="o">=</span><span class="n">sk_std</span><span class="p">,</span> <span class="n">tf_legend</span><span class="o">=</span><span class="n">tf_legend</span><span class="p">,</span>
                 <span class="n">xlabel</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">color_style</span><span class="o">=</span><span class="s1">&#39;continuous&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h</span></div>


<div class="viewcode-block" id="PsthPlotCdtn"><a class="viewcode-back" href="../index.html#PyNeuroPlot.PsthPlotCdtn">[docs]</a><span class="k">def</span> <span class="nf">PsthPlotCdtn</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">,</span> <span class="n">data_df</span><span class="p">,</span> <span class="n">i_signal</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">grpby</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">fltr</span><span class="o">=</span><span class="p">[],</span> <span class="n">sk_std</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subpanel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tf_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Obsolete funciton &quot;&quot;&quot;</span>

    <span class="n">data_neuro</span> <span class="o">=</span> <span class="n">signal_align</span><span class="o">.</span><span class="n">neuro_sort</span><span class="p">(</span><span class="n">data_df</span><span class="p">,</span> <span class="n">grpby</span><span class="o">=</span><span class="n">grpby</span><span class="p">,</span> <span class="n">fltr</span><span class="o">=</span><span class="n">fltr</span><span class="p">,</span> <span class="n">neuro</span><span class="o">=</span><span class="n">data_neuro</span><span class="p">)</span>

    <span class="n">ts</span> <span class="o">=</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span>
    <span class="c1"># plot function for every panel</span>
    <span class="n">functionPlot</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">PsthPlot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ts</span><span class="o">=</span><span class="n">ts</span><span class="p">,</span> <span class="n">sk_std</span><span class="o">=</span><span class="n">sk_std</span><span class="p">,</span> <span class="n">tf_legend</span><span class="o">=</span><span class="n">tf_legend</span><span class="p">,</span> <span class="n">color_style</span><span class="o">=</span><span class="s1">&#39;continuous&#39;</span><span class="p">)</span>

    <span class="c1"># plot every condition in every panel</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">SmartSubplot</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">,</span> <span class="n">functionPlot</span><span class="p">,</span> <span class="n">dataPlot</span><span class="o">=</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][:,:,</span><span class="n">i_signal</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">h</span></div>


<div class="viewcode-block" id="SpectrogramPlot"><a class="viewcode-back" href="../index.html#PyNeuroPlot.SpectrogramPlot">[docs]</a><span class="k">def</span> <span class="nf">SpectrogramPlot</span><span class="p">(</span><span class="n">spcg</span><span class="p">,</span> <span class="n">spcg_t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spcg_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit_trial</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">tf_phase</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tf_mesh_t</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tf_mesh_f</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">tf_log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">time_baseline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">t_lim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f_lim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">c_lim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">c_lim_style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name_cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">rate_interp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tf_colorbar</span><span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">quiver_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_quiver</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    plot power spectrogram or coherence-gram, input spcg could be [ N_t * N*f ] or [ N_trial * N_t * N*f ], real or complex</span>

<span class="sd">    :param spcg:          2D numpy array, [ N_t * N*f ] or 3D numpy array [ N_trial * N_t * N*f ], either real or complex:</span>

<span class="sd">                            * if [ N_trial * N_t * N*f ], average over trial and get [ N_t * N*f ]</span>
<span class="sd">                            * if complex, plot spectrogram using its abs value, and plot quiver using the complex value</span>
<span class="sd">    :param spcg_t:        tick of time, length N_t</span>
<span class="sd">    :param spcg_f:        tick of frequency, length N_f</span>
<span class="sd">    :param limit_trial:   index array to specify which trials to use</span>
<span class="sd">    :param tf_phase:      true/false, plot phase using quiver (spcg has to be complex): points down if negative phase (singal1 lags signal0 for coherence)</span>
<span class="sd">    :param tf_mesh_t:     true/false, plot LinemeshFlatPlot, focuse on t, (horizontal lines)</span>
<span class="sd">    :param tf_mesh_f:     true/false, plot LinemeshFlatPlot, focuse on f, (vertical lines)</span>
<span class="sd">    :param tf_log:        true/false, use log scale</span>
<span class="sd">    :param c_lim_style:   &#39;basic&#39; (min, max), &#39;from_zero&#39; (0, max), or &#39;diverge&#39; (-max, max); default to None, select automatically based on tf_log and time_baseline</span>
<span class="sd">    :param time_baseline: baseline time period to be subtracted, eg. [-0.1, 0.05], default to None</span>
<span class="sd">    :param name_cmap:     name of color map to use, default to &#39;inferno&#39;, if use diverge c_map, automatically change to &#39;coolwarm&#39;; another suggested one is &#39;viridis&#39;</span>
<span class="sd">    :param rate_interp:   rate of interpolation for plotting, if None, do not interpolate, suggested value is 8</span>
<span class="sd">    :param tf_colorbar:   true/false, plot colorbar</span>
<span class="sd">    :return:              figure handle</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">tf_log</span><span class="p">:</span>                   <span class="c1"># if use log scale</span>
        <span class="n">spcg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">spcg</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">32</span><span class="p">))</span> <span class="o">-</span> <span class="mi">6</span>         <span class="c1"># prevent log(0) error</span>

    <span class="k">if</span> <span class="n">limit_trial</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spcg</span> <span class="o">=</span> <span class="n">spcg</span><span class="p">[</span><span class="n">limit_trial</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

    <span class="k">if</span> <span class="n">spcg</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>           <span class="c1"># if contains many trials, calculate average</span>
        <span class="n">spcg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spcg</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">spcg</span><span class="p">)):</span>     <span class="c1"># if imaginary, keep the origianl and calculate abs</span>
        <span class="n">spcg_complex</span> <span class="o">=</span> <span class="n">spcg</span>
        <span class="n">spcg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spcg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spcg_complex</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">spcg_t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spcg_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">spcg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">spcg_f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spcg_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">spcg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># if use reference period for baseline, subtract baseline</span>
    <span class="k">if</span> <span class="n">time_baseline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spcg_baseline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">spcg</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">spcg_t</span> <span class="o">&gt;=</span> <span class="n">time_baseline</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spcg_t</span> <span class="o">&lt;</span> <span class="n">time_baseline</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
                                 <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">spcg</span> <span class="o">=</span> <span class="n">spcg</span> <span class="o">-</span> <span class="n">spcg_baseline</span>

    <span class="c1"># set x, y limit</span>
    <span class="k">if</span> <span class="n">t_lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t_lim</span> <span class="o">=</span> <span class="n">spcg_t</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tf_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">spcg_t</span><span class="o">&gt;=</span><span class="n">t_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spcg_t</span><span class="o">&lt;=</span><span class="n">t_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">spcg_t</span> <span class="o">=</span> <span class="n">spcg_t</span><span class="p">[</span><span class="n">tf_temp</span><span class="p">]</span>
        <span class="n">spcg</span>   <span class="o">=</span> <span class="n">spcg</span><span class="p">[:,</span> <span class="n">tf_temp</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">f_lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">f_lim</span> <span class="o">=</span> <span class="n">spcg_f</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tf_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">spcg_f</span> <span class="o">&gt;=</span> <span class="n">f_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spcg_f</span> <span class="o">&lt;=</span> <span class="n">f_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">spcg_f</span> <span class="o">=</span> <span class="n">spcg_f</span><span class="p">[</span><span class="n">tf_temp</span><span class="p">]</span>
        <span class="n">spcg</span> <span class="o">=</span> <span class="n">spcg</span><span class="p">[</span><span class="n">tf_temp</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># set color limit</span>
    <span class="k">if</span> <span class="n">c_lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c_lim_style</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time_baseline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># if use reference period, symmetric about zero</span>
                <span class="n">c_lim_style</span> <span class="o">=</span> <span class="s1">&#39;diverge&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">tf_log</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">spcg</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)):</span>  <span class="c1"># if not log scale and no nagative values</span>
                    <span class="n">c_lim_style</span> <span class="o">=</span> <span class="s1">&#39;from_zero&#39;</span>
                <span class="k">else</span><span class="p">:</span>                                      <span class="c1"># otherwise, use basic</span>
                    <span class="n">c_lim_style</span> <span class="o">=</span> <span class="s1">&#39;basic&#39;</span>

        <span class="k">if</span> <span class="n">c_lim_style</span> <span class="o">==</span> <span class="s1">&#39;diverge&#39;</span><span class="p">:</span>       <span class="c1"># if &#39;deverge&#39;, set to [-a,a]</span>
            <span class="n">c_lim</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spcg</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spcg</span><span class="p">))]</span>
        <span class="k">elif</span> <span class="n">c_lim_style</span> <span class="o">==</span> <span class="s1">&#39;from_zero&#39;</span><span class="p">:</span>   <span class="c1"># if &#39;from zero&#39;, set to [0,a]</span>
            <span class="n">c_lim</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spcg</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="n">c_lim_style</span> <span class="o">==</span> <span class="s1">&#39;basic&#39;</span><span class="p">:</span>       <span class="c1"># otherwise, use &#39;basic&#39;, set to [a,b]</span>
            <span class="n">c_lim</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">spcg</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spcg</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c_lim</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">spcg</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spcg</span><span class="p">)]</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;c_lim_style not recognized, must be &quot;basic&quot;, &quot;from_zero&quot;, &quot;diverge&quot;, or None &#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">name_cmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c_lim_style</span> <span class="o">==</span> <span class="s1">&#39;diverge&#39;</span><span class="p">:</span>
            <span class="n">name_cmap</span> <span class="o">=</span> <span class="s1">&#39;coolwarm&#39;</span>  <span class="c1"># use divergence colormap</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name_cmap</span> <span class="o">=</span> <span class="s1">&#39;inferno&#39;</span>   <span class="c1"># default to inferno</span>

    <span class="k">if</span> <span class="n">rate_interp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">f_interp</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp2d</span><span class="p">(</span><span class="n">spcg_t</span><span class="p">,</span> <span class="n">spcg_f</span><span class="p">,</span> <span class="n">spcg</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
        <span class="n">spcg_t_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">spcg_t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spcg_t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spcg_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rate_interp</span><span class="o">+</span><span class="mi">1</span> <span class="p">)</span>
        <span class="n">spcg_f_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">spcg_f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spcg_f</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spcg_f</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rate_interp</span><span class="o">+</span><span class="mi">1</span> <span class="p">)</span>
        <span class="n">spcg_plot</span>   <span class="o">=</span> <span class="n">f_interp</span><span class="p">(</span><span class="n">spcg_t_plot</span><span class="p">,</span> <span class="n">spcg_f_plot</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spcg_t_plot</span> <span class="o">=</span> <span class="n">spcg_t</span>
        <span class="n">spcg_f_plot</span> <span class="o">=</span> <span class="n">spcg_f</span>
        <span class="n">spcg_plot</span> <span class="o">=</span> <span class="n">spcg</span>

    <span class="c1"># plot using pcolormesh</span>
    <span class="n">h_plot</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">center2edge</span><span class="p">(</span><span class="n">spcg_t_plot</span><span class="p">),</span> <span class="n">center2edge</span><span class="p">(</span><span class="n">spcg_f_plot</span><span class="p">),</span>
                   <span class="n">spcg_plot</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">name_cmap</span><span class="p">),</span> <span class="n">shading</span><span class="o">=</span> <span class="s1">&#39;flat&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">t_lim</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">f_lim</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">c_lim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="n">c_lim</span><span class="p">)</span>
    <span class="c1"># color bar</span>
    <span class="k">if</span> <span class="n">tf_colorbar</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>

    <span class="c1"># quiver plot of phase: pointing down if negative phase, singal1 lags signal0 for coherence</span>
    <span class="k">if</span> <span class="n">tf_phase</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">spcg_complex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>                   <span class="c1"># plot a subset of quivers, to prevent them from filling the whole plot</span>
            <span class="k">if</span> <span class="n">max_quiver</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">max_quiver</span> <span class="o">=</span> <span class="mi">32</span>    <span class="c1"># max number of quivers every dimension (in both axis)</span>
            <span class="k">if</span> <span class="n">quiver_scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">quiver_scale</span> <span class="o">=</span> <span class="mi">32</span>  <span class="c1"># about 1/32 of axis length</span>
            <span class="p">[</span><span class="n">N_fs</span><span class="p">,</span> <span class="n">N_ts</span><span class="p">]</span> <span class="o">=</span> <span class="n">spcg</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">indx_fs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">keep_less_than</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N_fs</span><span class="p">),</span> <span class="n">max_quiver</span><span class="o">*</span><span class="mf">1.0</span><span class="o">*</span><span class="p">(</span><span class="n">spcg_f</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">spcg_f</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">f_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">f_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="n">indx_ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">keep_less_than</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N_ts</span><span class="p">),</span> <span class="n">max_quiver</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">spcg_t</span><span class="p">[</span><span class="n">indx_ts</span><span class="p">],</span> <span class="n">spcg_f</span><span class="p">[</span><span class="n">indx_fs</span><span class="p">],</span>
                       <span class="n">spcg_complex</span><span class="p">[</span><span class="n">indx_fs</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">indx_ts</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">spcg_complex</span><span class="p">[</span><span class="n">indx_fs</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">indx_ts</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span>
                       <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span>
                       <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">spcg</span><span class="p">,</span> <span class="mf">99.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">quiver_scale</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">spcg_t</span><span class="p">,</span> <span class="n">spcg_f</span><span class="p">,</span> <span class="n">spcg_complex</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">spcg_complex</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span>
                       <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">spcg</span><span class="p">,</span> <span class="mf">99.8</span><span class="p">)</span> <span class="o">*</span> <span class="n">quiver_scale</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tf_mesh_t</span><span class="p">:</span>
        <span class="n">LinemeshFlatPlot</span><span class="p">(</span><span class="n">spcg_plot</span><span class="p">,</span> <span class="n">spcg_t_plot</span><span class="p">,</span> <span class="n">spcg_f_plot</span><span class="p">,</span> <span class="n">N_mesh</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">axis_mesh</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tf_mesh_f</span><span class="p">:</span>
        <span class="n">LinemeshFlatPlot</span><span class="p">(</span><span class="n">spcg_plot</span><span class="p">,</span> <span class="n">spcg_t_plot</span><span class="p">,</span> <span class="n">spcg_f_plot</span><span class="p">,</span> <span class="n">N_mesh</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">axis_mesh</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">sci</span><span class="p">(</span><span class="n">h_plot</span><span class="p">)</span> <span class="c1"># set the current color-mappable object to be the specrogram plot but not the quiver</span>

    <span class="k">return</span> <span class="n">h_plot</span></div>


<div class="viewcode-block" id="LinemeshFlatPlot"><a class="viewcode-back" href="../index.html#PyNeuroPlot.LinemeshFlatPlot">[docs]</a><span class="k">def</span> <span class="nf">LinemeshFlatPlot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis_mesh</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                     <span class="n">N_mesh</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">scale_mesh</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;dimgrey&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    an alternative to pcolormesh, focuse on change along one dimension (x, or y)</span>

<span class="sd">    :param data:        2D numpy array (num_y * num_x), like the imput to imshow</span>
<span class="sd">    :param x_grid:      1D numpy array, num_x</span>
<span class="sd">    :param y_grid:      1D numpy array, num_x</span>
<span class="sd">    :param axis_mesh:   &#39;x&#39;, or &#39;y&#39;, the change on which axis you are interested in</span>
<span class="sd">    :param N_mesh:      number of lines to plot (controls thinning)</span>
<span class="sd">    :param scale_mesh:  the scale of individual lines relative the axis limit</span>
<span class="sd">    :param color:       color of lines</span>
<span class="sd">    :return:            handles of the lines</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">y_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">y_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">x_grid_2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">y_grid_2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">y_grid</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">axis_mesh</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
        <span class="n">factor_scale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">scale_mesh</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
        <span class="n">data_plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">*</span><span class="n">factor_scale</span> <span class="o">+</span> <span class="n">y_grid_2D</span>
        <span class="k">if</span> <span class="n">N_mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">N_mesh</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_grid</span><span class="p">)</span>
        <span class="n">indx_thin</span> <span class="o">=</span> <span class="n">keep_less_than</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_grid</span><span class="p">)),</span> <span class="n">N_mesh</span><span class="p">)</span>
        <span class="n">h_lines</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">data_plot</span><span class="p">[</span><span class="n">indx_thin</span><span class="p">,:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">axis_mesh</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
        <span class="n">factor_scale</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">scale_mesh</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
        <span class="n">data_plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">*</span><span class="n">factor_scale</span> <span class="o">+</span> <span class="n">x_grid_2D</span>
        <span class="k">if</span> <span class="n">N_mesh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">N_mesh</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_grid</span><span class="p">)</span>
        <span class="n">indx_thin</span> <span class="o">=</span> <span class="n">keep_less_than</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_grid</span><span class="p">)),</span> <span class="n">N_mesh</span><span class="p">)</span>
        <span class="n">h_lines</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_plot</span><span class="p">[:,</span><span class="n">indx_thin</span><span class="p">],</span> <span class="n">y_grid</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h_lines</span></div>



<div class="viewcode-block" id="SpectrogramAllPairPlot"><a class="viewcode-back" href="../index.html#PyNeuroPlot.SpectrogramAllPairPlot">[docs]</a><span class="k">def</span> <span class="nf">SpectrogramAllPairPlot</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">,</span> <span class="n">indx_chan</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_trial</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit_gap</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">t_bin</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">t_step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f_lim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">coh_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">batchsize</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot all LFP power specgtrogram (diagonal panels) and all pairwise coherence (off-diagonal panels)</span>

<span class="sd">    :param data_neuro: standard data input</span>
<span class="sd">    :param indx_chan:  index of channels to plot (from zero)</span>
<span class="sd">    :param max_trial:  a interger, use only max_trial from all trials to speedup the calculation</span>
<span class="sd">    :param limit_gap:  the gap between channels to plot, used when indx_chan is None. e.g. if limit_gap=4, the indx_chan=[0,4,8,...]</span>
<span class="sd">    :param t_bin:      time bin size for spectrogram</span>
<span class="sd">    :param t_step:     time step size for spectrogram</span>
<span class="sd">    :param f_lim:      frequency limit for plot (ylim)</span>
<span class="sd">    :param coh_lim:    lim for coherence plot, control clim</span>
<span class="sd">    :param t_axis:     axis index of time in data_neuro[&#39;data&#39;]</span>
<span class="sd">    :param batchsize:  batch size for ComputeSpectrogram, used to prevent memory overloading</span>
<span class="sd">    :param verbose:    if print some intermediate results</span>
<span class="sd">    :return:           [h_fig, h_ax], handles of figure and axes</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">PyNeuroAna</span> <span class="k">as</span> <span class="nn">pna</span>

    <span class="c1"># calculate the channel index used for plotting</span>
    <span class="n">N_chan</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;signal_info&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">indx_chan</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">indx_chan</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N_chan</span><span class="p">,</span> <span class="n">limit_gap</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">indx_chan</span><span class="p">,</span>  <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">signal_info</span> <span class="o">=</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;signal_info&#39;</span><span class="p">][</span><span class="n">indx_chan</span><span class="p">]</span>
    <span class="n">N_plot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx_chan</span><span class="p">)</span>

    <span class="c1"># use only a subset of trials to speedup the function</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">max_trial</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">max_trial</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">max_trial</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>  <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">fs</span> <span class="o">=</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;signal_info&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">t_ini</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># compute spectrogram</span>
    <span class="n">spcg_all</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i_plot</span><span class="p">,</span> <span class="n">i_chan</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indx_chan</span><span class="p">):</span>
        <span class="p">[</span><span class="n">spcg_cur</span><span class="p">,</span> <span class="n">spcg_t</span><span class="p">,</span> <span class="n">spcg_f</span><span class="p">]</span> <span class="o">=</span> <span class="n">pna</span><span class="o">.</span><span class="n">ComputeSpectrogram</span><span class="p">(</span><span class="n">data</span><span class="p">[:,:,</span><span class="n">i_plot</span><span class="p">],</span> <span class="n">data1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">t_ini</span><span class="o">=</span><span class="n">t_ini</span><span class="p">,</span> <span class="n">t_bin</span><span class="o">=</span><span class="n">t_bin</span><span class="p">,</span> <span class="n">t_step</span><span class="o">=</span><span class="n">t_step</span><span class="p">,</span> <span class="n">t_axis</span><span class="o">=</span><span class="n">t_axis</span><span class="p">,</span> <span class="n">f_lim</span><span class="o">=</span><span class="n">f_lim</span><span class="p">,</span> <span class="n">batchsize</span><span class="o">=</span><span class="n">batchsize</span><span class="p">)</span>
        <span class="n">spcg_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spcg_cur</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">)</span>

    <span class="c1"># plot</span>
    <span class="n">text_props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="p">[</span><span class="n">h_fig</span><span class="p">,</span> <span class="n">h_ax</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">N_plot</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">N_plot</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">])</span>
    <span class="n">h_fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span><span class="mi">9</span><span class="p">])</span>
    <span class="n">h_fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">indx_row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_plot</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">indx_col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_plot</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">indx_row</span> <span class="o">==</span> <span class="n">indx_col</span><span class="p">:</span>            <span class="c1"># power spectrogram on diagonal panels</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">h_ax</span><span class="p">[</span><span class="n">indx_row</span><span class="p">,</span> <span class="n">indx_col</span><span class="p">])</span>
                <span class="n">h_plot_pow</span> <span class="o">=</span> <span class="n">SpectrogramPlot</span><span class="p">(</span><span class="n">spcg_all</span><span class="p">[</span><span class="n">indx_row</span><span class="p">],</span> <span class="n">spcg_t</span><span class="p">,</span> <span class="n">spcg_f</span><span class="p">,</span> <span class="n">tf_log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">f_lim</span><span class="o">=</span><span class="n">f_lim</span><span class="p">,</span> <span class="n">time_baseline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">rate_interp</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">signal_info</span><span class="p">[</span><span class="n">indx_row</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">text_props</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">indx_row</span><span class="o">&lt;</span><span class="n">indx_col</span><span class="p">:</span>             <span class="c1"># coherence on off diagonal panels</span>
                <span class="c1"># compute coherence</span>
                <span class="p">[</span><span class="n">cohg</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">pna</span><span class="o">.</span><span class="n">ComputeCoherogram</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">indx_row</span><span class="p">],</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">indx_col</span><span class="p">],</span> <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">t_ini</span><span class="o">=</span><span class="n">t_ini</span><span class="p">,</span> <span class="n">t_bin</span><span class="o">=</span><span class="n">t_bin</span><span class="p">,</span> <span class="n">t_step</span><span class="o">=</span><span class="n">t_step</span><span class="p">,</span> <span class="n">f_lim</span><span class="o">=</span><span class="n">f_lim</span><span class="p">,</span>
                                       <span class="n">batchsize</span><span class="o">=</span><span class="n">batchsize</span><span class="p">,</span> <span class="n">data0_spcg_ave</span><span class="o">=</span><span class="n">spcg_all</span><span class="p">[</span><span class="n">indx_row</span><span class="p">],</span> <span class="n">data1_spcg_ave</span><span class="o">=</span><span class="n">spcg_all</span><span class="p">[</span><span class="n">indx_col</span><span class="p">])</span>

                <span class="c1"># plot on two symmetric panels</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">h_ax</span><span class="p">[</span><span class="n">indx_row</span><span class="p">,</span> <span class="n">indx_col</span><span class="p">])</span>
                <span class="n">h_plot_coh</span> <span class="o">=</span> <span class="n">SpectrogramPlot</span><span class="p">(</span><span class="n">cohg</span><span class="p">,</span> <span class="n">spcg_t</span><span class="p">,</span> <span class="n">spcg_f</span><span class="p">,</span> <span class="n">tf_log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">f_lim</span><span class="o">=</span><span class="n">f_lim</span><span class="p">,</span>
                                <span class="n">time_baseline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rate_interp</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">name_cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">c_lim</span><span class="o">=</span><span class="n">coh_lim</span><span class="p">)</span>
                <span class="c1"># plt.text(0.03, 0.85, &#39;{}-{}&#39;.format(signal_info[indx_row][0],signal_info[indx_col][0]), transform=plt.gca().transAxes,</span>
                <span class="c1">#          bbox=text_props)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">h_ax</span><span class="p">[</span><span class="n">indx_col</span><span class="p">,</span> <span class="n">indx_row</span><span class="p">])</span>
                <span class="n">h_plot_coh</span> <span class="o">=</span> <span class="n">SpectrogramPlot</span><span class="p">(</span><span class="n">cohg</span><span class="p">,</span> <span class="n">spcg_t</span><span class="p">,</span> <span class="n">spcg_f</span><span class="p">,</span> <span class="n">tf_log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">f_lim</span><span class="o">=</span><span class="n">f_lim</span><span class="p">,</span>
                                <span class="n">time_baseline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rate_interp</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">name_cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">c_lim</span><span class="o">=</span><span class="n">coh_lim</span><span class="p">)</span>
                <span class="c1"># plt.text(0.03, 0.85, &#39;{}-{}&#39;.format(signal_info[indx_col][0], signal_info[indx_row][0]),</span>
                <span class="c1">#          transform=plt.gca().transAxes,</span>
                <span class="c1">#          bbox=text_props)</span>

    <span class="c1"># share clim for all diagonal panels</span>
    <span class="n">ax_diag</span> <span class="o">=</span> <span class="n">h_ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N_plot</span><span class="o">*</span><span class="n">N_plot</span><span class="p">,</span><span class="n">N_plot</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">share_clim</span><span class="p">(</span> <span class="n">ax_diag</span> <span class="p">)</span>
    <span class="c1"># share clim for all off-diagonal panels</span>
    <span class="n">ax_nondiag</span> <span class="o">=</span> <span class="n">h_ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N_plot</span> <span class="o">*</span> <span class="n">N_plot</span><span class="p">))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N_plot</span> <span class="o">*</span> <span class="n">N_plot</span><span class="p">,</span> <span class="n">N_plot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))]</span>
    <span class="n">share_clim</span><span class="p">(</span> <span class="n">ax_nondiag</span> <span class="p">)</span>

    <span class="c1"># add colorbar</span>
    <span class="n">h_fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">h_plot_pow</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">h_ax</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">N_plot</span><span class="o">//</span><span class="mi">2</span><span class="p">,:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">h_fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">h_plot_coh</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">h_ax</span><span class="p">[</span><span class="n">N_plot</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span><span class="n">N_plot</span><span class="p">,:]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="c1"># plt.suptitle(&#39;Power Spectrogram and Cohrence plot&#39;, fontsize=12)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">h_fig</span><span class="p">,</span> <span class="n">h_ax</span><span class="p">]</span></div>



<div class="viewcode-block" id="EmbedTracePlot"><a class="viewcode-back" href="../index.html#PyNeuroPlot.EmbedTracePlot">[docs]</a><span class="k">def</span> <span class="nf">EmbedTracePlot</span><span class="p">(</span><span class="n">loc_embed</span><span class="p">,</span> <span class="n">traces</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels_interactive</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">highlight</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot trances (e.g. ERPs) in the embeded 2D space, if labels_interactive is not None, the plot is interactive</span>

<span class="sd">    :param loc_embedding: [N*2] array, where each row stores the [x, y] of every data point in the embedded space</span>
<span class="sd">    :param traces:        if None, do not plot original</span>
<span class="sd">    :param labels:        labels of every point</span>
<span class="sd">    :param labels_interactive: labels of every point, shown as annotation when clicked by mouse</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="sd">&quot;&quot;&quot;&quot; scatter plot for every data point &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">color</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">loc_embed</span><span class="p">),</span> <span class="mi">3</span><span class="p">])</span><span class="o">+</span><span class="mf">0.5</span>
    <span class="n">h_scatter</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">loc_embed</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">loc_embed</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">picker</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="sd">&quot;&quot;&quot; label shown in figure &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">loc_embed</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">xy</span><span class="o">=</span><span class="n">xy</span><span class="p">)</span>

    <span class="sd">&quot;&quot;&quot; plot traces &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">traces</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scale_trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">traces</span><span class="p">))</span>
        <span class="n">scale_embedding</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">loc_embed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">loc_embed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">highlight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">loc_embed</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">loc_embed</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">traces</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">scale_embedding</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">traces</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">20</span><span class="p">,</span>
                         <span class="n">loc_embed</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">traces</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">scale_trace</span> <span class="o">*</span> <span class="n">scale_embedding</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">20</span><span class="p">,</span>
                         <span class="n">color</span> <span class="o">=</span> <span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">loc_embed</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">highlight</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">loc_embed</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">traces</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">scale_embedding</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">traces</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">20</span><span class="p">,</span>
                             <span class="n">loc_embed</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">traces</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">scale_trace</span> <span class="o">*</span> <span class="n">scale_embedding</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">20</span><span class="p">,</span>
                             <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">h_scatter</span><span class="o">.</span><span class="n">set_sizes</span><span class="p">(</span><span class="n">h_scatter</span><span class="o">.</span><span class="n">get_sizes</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">highlight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">h_scatter</span><span class="o">.</span><span class="n">set_sizes</span><span class="p">(</span><span class="n">h_scatter</span><span class="o">.</span><span class="n">get_sizes</span><span class="p">()</span><span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">h_scatter</span><span class="o">.</span><span class="n">get_sizes</span><span class="p">()</span><span class="o">*</span><span class="n">highlight</span><span class="p">)</span>


    <span class="sd">&quot;&quot;&quot; label shown by mouse clicking &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">labels_interactive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">h_text</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="n">loc_embed</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">onpick</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">h_text</span><span class="o">=</span><span class="n">h_text</span><span class="p">):</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">ind</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">:</span>
                <span class="n">h_text</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labels_interactive</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="n">h_text</span><span class="o">.</span><span class="n">set_x</span><span class="p">(</span><span class="n">loc_embed</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">h_text</span><span class="o">.</span><span class="n">set_y</span><span class="p">(</span><span class="n">loc_embed</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;pick_event&#39;</span><span class="p">,</span> <span class="n">onpick</span><span class="p">)</span></div>



<span class="sd">&quot;&quot;&quot; ========== ========= tool functions ========== ========== &quot;&quot;&quot;</span>



<span class="k">def</span> <span class="nf">get_unique_elements</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">)))</span>



<div class="viewcode-block" id="add_axes_on_top"><a class="viewcode-back" href="../index.html#PyNeuroPlot.add_axes_on_top">[docs]</a><span class="k">def</span> <span class="nf">add_axes_on_top</span><span class="p">(</span><span class="n">h_axes</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mf">0.25</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    tool funciton to add an axes on the top of the existing axis, used by funciton PsthPlot</span>

<span class="sd">    :param h_axes: the curret axex handle</span>
<span class="sd">    :param r:      ratio of the height of the newly added axes</span>
<span class="sd">    :return:       axis handle</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get axes position</span>
    <span class="n">axes_rect</span> <span class="o">=</span> <span class="n">h_axes</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
    <span class="c1"># make the curretn axes smaller</span>
    <span class="n">h_axes</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="n">axes_rect</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">axes_rect</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="n">axes_rect</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">axes_rect</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">r</span><span class="p">)])</span>
    <span class="c1"># add a new axes</span>
    <span class="n">h_axes_top</span> <span class="o">=</span> <span class="n">h_axes</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="n">axes_rect</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">axes_rect</span><span class="o">.</span><span class="n">y0</span><span class="o">+</span><span class="n">axes_rect</span><span class="o">.</span><span class="n">height</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">r</span><span class="p">),</span> <span class="n">axes_rect</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">axes_rect</span><span class="o">.</span><span class="n">height</span><span class="o">*</span><span class="n">r</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">h_axes</span><span class="p">)</span>
    <span class="n">h_axes_top</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="c1"># h_axes_top.set_xticklabels({})</span>
    <span class="k">try</span><span class="p">:</span>    <span class="c1"># for differenet versions of matploblib</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">h_axes_top</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">([</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">h_axes_top</span><span class="o">.</span><span class="n">set_axis_bgcolor</span><span class="p">([</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">h_axes_top</span></div>


<div class="viewcode-block" id="add_sub_axes"><a class="viewcode-back" href="../index.html#PyNeuroPlot.add_sub_axes">[docs]</a><span class="k">def</span> <span class="nf">add_sub_axes</span><span class="p">(</span><span class="n">h_axes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">gap</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">sub_rect</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    tool funciton to add an axes around the existing axis</span>

<span class="sd">    :param h_axes: the current axes handle, default to None, use the gca</span>
<span class="sd">    :param loc:    location of the newly added sub-axes: one of [&#39;top&#39;, &#39;bottom&#39;, &#39;left&#39;, &#39;right&#39;, &#39;custom&#39;], default to &#39;top&#39;</span>

<span class="sd">                    - if one of [&#39;top&#39;, &#39;bottom&#39;, &#39;left&#39;, &#39;right&#39;], the size of sub axes is determined by size and gap parameter;</span>
<span class="sd">                    - if set to &#39;custom&#39;, the location and size if specifited by sub_rect parameter</span>
<span class="sd">    :param size:   size of the sub-axes, with respect to the origial axes, default to 0.25</span>
<span class="sd">    :param gap:    gap between the original axes and and the newly added sub-axes</span>
<span class="sd">    :param sub_rect: the rect of custom sub-axes, rect = [x_left, y_bottom, ]</span>
<span class="sd">    :return:       handle of sub axes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">h_axes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">h_axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="c1"># get axes position</span>
    <span class="n">axes_rect</span> <span class="o">=</span> <span class="n">h_axes</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">axes_rect</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">axes_rect</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="n">axes_rect</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">axes_rect</span><span class="o">.</span><span class="n">height</span>


    <span class="c1"># set modefied axes and new sub-axes position</span>
    <span class="k">if</span> <span class="n">sub_rect</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;custom&#39;</span>
    <span class="k">if</span> <span class="n">loc</span> <span class="o">==</span> <span class="s1">&#39;top&#39;</span><span class="p">:</span>
        <span class="n">x0_new</span><span class="p">,</span> <span class="n">y0_new</span><span class="p">,</span> <span class="n">width_new</span><span class="p">,</span> <span class="n">height_new</span> <span class="o">=</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">size</span> <span class="o">-</span> <span class="n">gap</span><span class="p">)</span>
        <span class="n">x0_sub</span><span class="p">,</span> <span class="n">y0_sub</span><span class="p">,</span> <span class="n">width_sub</span><span class="p">,</span> <span class="n">height_sub</span> <span class="o">=</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="o">+</span><span class="n">height</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">size</span><span class="p">),</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">*</span> <span class="n">size</span>
        <span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span> <span class="o">=</span> <span class="n">h_axes</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">loc</span> <span class="o">==</span> <span class="s1">&#39;bottom&#39;</span><span class="p">:</span>
        <span class="n">x0_new</span><span class="p">,</span> <span class="n">y0_new</span><span class="p">,</span> <span class="n">width_new</span><span class="p">,</span> <span class="n">height_new</span> <span class="o">=</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">height</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">gap</span><span class="p">),</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">size</span> <span class="o">-</span> <span class="n">gap</span><span class="p">)</span>
        <span class="n">x0_sub</span><span class="p">,</span> <span class="n">y0_sub</span><span class="p">,</span> <span class="n">width_sub</span><span class="p">,</span> <span class="n">height_sub</span> <span class="o">=</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">*</span> <span class="n">size</span>
        <span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span> <span class="o">=</span> <span class="n">h_axes</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">loc</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
        <span class="n">x0_new</span><span class="p">,</span> <span class="n">y0_new</span><span class="p">,</span> <span class="n">width_new</span><span class="p">,</span> <span class="n">height_new</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">gap</span><span class="p">),</span> <span class="n">y0</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">size</span> <span class="o">-</span> <span class="n">gap</span><span class="p">),</span> <span class="n">height</span>
        <span class="n">x0_sub</span><span class="p">,</span> <span class="n">y0_sub</span><span class="p">,</span> <span class="n">width_sub</span><span class="p">,</span> <span class="n">height_sub</span> <span class="o">=</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="n">size</span><span class="p">,</span> <span class="n">height</span>
        <span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">h_axes</span>
    <span class="k">elif</span> <span class="n">loc</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
        <span class="n">x0_new</span><span class="p">,</span> <span class="n">y0_new</span><span class="p">,</span> <span class="n">width_new</span><span class="p">,</span> <span class="n">height_new</span> <span class="o">=</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">size</span> <span class="o">-</span> <span class="n">gap</span><span class="p">),</span> <span class="n">height</span>
        <span class="n">x0_sub</span><span class="p">,</span> <span class="n">y0_sub</span><span class="p">,</span> <span class="n">width_sub</span><span class="p">,</span> <span class="n">height_sub</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">size</span><span class="p">),</span> <span class="n">y0</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="n">size</span><span class="p">,</span> <span class="n">height</span>
        <span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">h_axes</span>
    <span class="k">elif</span> <span class="n">loc</span> <span class="o">==</span> <span class="s1">&#39;custom&#39;</span><span class="p">:</span>
        <span class="n">x0_rel</span><span class="p">,</span> <span class="n">y0_rel</span><span class="p">,</span> <span class="n">width_rel</span><span class="p">,</span> <span class="n">height_rel</span> <span class="o">=</span> <span class="n">sub_rect</span>
        <span class="n">x0_new</span><span class="p">,</span> <span class="n">y0_new</span><span class="p">,</span> <span class="n">width_new</span><span class="p">,</span> <span class="n">height_new</span> <span class="o">=</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span>
        <span class="n">x0_sub</span><span class="p">,</span> <span class="n">y0_sub</span><span class="p">,</span> <span class="n">width_sub</span><span class="p">,</span> <span class="n">height_sub</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">x0_rel</span> <span class="o">*</span> <span class="n">width</span><span class="p">,</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">y0_rel</span> <span class="o">*</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="n">width_rel</span><span class="p">,</span> <span class="n">height</span> <span class="o">*</span> <span class="n">height_rel</span>
        <span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;loc has to be one of &quot;top&quot;, &quot;bottom&quot;, &quot;left&quot;, &quot;right&quot;, or &quot;custom&quot;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># make the curretn axes smaller</span>
    <span class="n">h_axes</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="n">x0_new</span><span class="p">,</span> <span class="n">y0_new</span><span class="p">,</span> <span class="n">width_new</span><span class="p">,</span> <span class="n">height_new</span><span class="p">])</span>
    <span class="c1"># add a new axes</span>
    <span class="n">h_subaxes</span> <span class="o">=</span> <span class="n">h_axes</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="n">x0_sub</span><span class="p">,</span> <span class="n">y0_sub</span><span class="p">,</span> <span class="n">width_sub</span><span class="p">,</span> <span class="n">height_sub</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">sharex</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">)</span>

    <span class="c1"># adjust tick labels</span>
    <span class="k">if</span> <span class="n">loc</span> <span class="o">==</span> <span class="s1">&#39;top&#39;</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">h_subaxes</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">loc</span> <span class="o">==</span> <span class="s1">&#39;bottom&#39;</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">h_axes</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">loc</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">h_axes</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">loc</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">h_subaxes</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">h_subaxes</span></div>






<div class="viewcode-block" id="create_array_layout_subplots"><a class="viewcode-back" href="../index.html#PyNeuroPlot.create_array_layout_subplots">[docs]</a><span class="k">def</span> <span class="nf">create_array_layout_subplots</span><span class="p">(</span><span class="n">array_layout</span><span class="p">,</span> <span class="n">tf_linear_indx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tf_text_ch</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create the subplots based on the electrode array&#39;s spatial layout</span>

<span class="sd">    :param array_layout:   electrode array&#39;s spatial layout, a dict, {chan: (row, column)}</span>
<span class="sd">    :param tf_linear_indx: True/False the returned subplot axis is a 1D array, indexed in the channel orders, default to True</span>
<span class="sd">    :param tf_text_ch:     True/False show the channel index for every axes</span>
<span class="sd">    :return: [h_fig, h_axes],as the plt.subplots</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">[</span><span class="n">ch</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">([[</span><span class="n">ch</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">ch</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="n">array_layout</span><span class="o">.</span><span class="n">items</span><span class="p">()]))</span>
    <span class="n">max_r</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">max_c</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="c1"># create subplots</span>
    <span class="p">[</span><span class="n">h_fig</span><span class="p">,</span> <span class="n">h_axes</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">max_r</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_c</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">h_axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">h_axes</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># set all axes off</span>
    <span class="k">for</span> <span class="n">r_cur</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c_cur</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">h_axes</span><span class="p">[</span><span class="n">r_cur</span><span class="p">,</span> <span class="n">c_cur</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>

    <span class="c1"># for the valid axes, set them on, and create a list of axes according to the order of channels</span>
    <span class="n">h_axes_linear</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ch_cur</span><span class="p">,</span> <span class="n">ch_loc</span>  <span class="ow">in</span> <span class="n">array_layout</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">h_axes_linear</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h_axes</span><span class="p">[</span><span class="n">ch_loc</span><span class="p">])</span>
        <span class="n">h_axes</span><span class="p">[</span><span class="n">ch_loc</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_on</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">tf_text_ch</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">h_axes</span><span class="p">[</span><span class="n">ch_loc</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">,</span> <span class="s1">&#39;Ch </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ch_cur</span><span class="p">),</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                     <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
                     <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;wheat&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span>

    <span class="c1"># if true, return the axes according to the channel, otherwise, returns 2D axes array</span>
    <span class="k">if</span> <span class="n">tf_linear_indx</span><span class="p">:</span>
        <span class="n">h_axes</span> <span class="o">=</span> <span class="n">h_axes_linear</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">h_fig</span><span class="p">,</span> <span class="n">h_axes</span><span class="p">]</span></div>


<div class="viewcode-block" id="AutoRowCol"><a class="viewcode-back" href="../index.html#PyNeuroPlot.AutoRowCol">[docs]</a><span class="k">def</span> <span class="nf">AutoRowCol</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    tool function to automatically calculate number of row and col based on total number of panels</span>

<span class="sd">    :param N:      total number of panels</span>
<span class="sd">    :param nrow:   optional, the desired number of rows, if given, fix the number of rows</span>
<span class="sd">    :param ncol:   optional, the desired number of columns, if given, fix the number of columns</span>
<span class="sd">    :param aspect: desired aspect ratio: ncol/nrow, default to 1/1</span>
<span class="sd">    :return:       (nrow, ncol)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">nrow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ncol</span><span class="p">,</span> <span class="n">rem</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">nrow</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">rem</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ncol</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">ncol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nrow</span><span class="p">,</span> <span class="n">rem</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">ncol</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">rem</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nrow</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ncol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">aspect</span><span class="p">)))</span>
        <span class="n">nrow</span><span class="p">,</span> <span class="n">rem</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">ncol</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">rem</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nrow</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span></div>


<div class="viewcode-block" id="SubplotsAutoRowCol"><a class="viewcode-back" href="../index.html#PyNeuroPlot.SubplotsAutoRowCol">[docs]</a><span class="k">def</span> <span class="nf">SubplotsAutoRowCol</span><span class="p">(</span><span class="n">num_panels</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    tool function to create subplots using the number of panels, a wrapper of plt.subplots() and AutoRowCol()</span>

<span class="sd">    the function will automatically decide the number of rows and columns, and the returned h_axes is a linear array .</span>

<span class="sd">    :param num_panels: total number of subplot panels</span>
<span class="sd">    :param nrow:       optional, the desired number of rows,</span>
<span class="sd">    :param ncol:       optional, the desired number of columns,</span>
<span class="sd">    :param aspect:     optional, the desired ratio: ncol/nrow, default to 1/1</span>
<span class="sd">    :param kwargs:     other arguments to pass to plt.subplots()</span>
<span class="sd">    :return:           h_fig, h_axes,  where h_axes is a linear array of axes</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get the number of rows and columns</span>
    <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">AutoRowCol</span><span class="p">(</span><span class="n">num_panels</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">ncol</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">aspect</span><span class="p">)</span>

    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;squeeze&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">h_fig</span><span class="p">,</span> <span class="n">h_axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">h_axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">h_axes</span><span class="p">)</span>    <span class="c1"># make it a 1D array</span>
    <span class="k">return</span> <span class="n">h_fig</span><span class="p">,</span> <span class="n">h_axes</span></div>


<div class="viewcode-block" id="DetermineClimCmap"><a class="viewcode-back" href="../index.html#PyNeuroPlot.DetermineClimCmap">[docs]</a><span class="k">def</span> <span class="nf">DetermineClimCmap</span><span class="p">(</span><span class="n">clim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_range</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    determine clim and cmap for plotting</span>
<span class="sd">    :param clim:       either string in (&quot;basic&quot;, &quot;diverge&quot;, &quot;from_zero&quot;), or two values like [1, 5], default to &#39;basic&#39; if None</span>
<span class="sd">    :param data_range: either two values like [1, 5] or a numpy array of the actual data</span>
<span class="sd">    :return:           (clim, cmap), ready to be used in plt.pcolormesh</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">clim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clim</span> <span class="o">=</span> <span class="s1">&#39;basic&#39;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clim</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">clim</span> <span class="o">==</span> <span class="s1">&#39;basic&#39;</span><span class="p">:</span>
            <span class="n">clim</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data_range</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data_range</span><span class="p">))</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;inferno&#39;</span>
        <span class="k">elif</span> <span class="n">clim</span> <span class="o">==</span> <span class="s1">&#39;diverge&#39;</span><span class="p">:</span>
            <span class="n">data_range_abs_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data_range</span><span class="p">))</span>
            <span class="n">clim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">data_range_abs_max</span><span class="p">,</span> <span class="n">data_range_abs_max</span><span class="p">)</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;coolwarm&#39;</span>
        <span class="k">elif</span> <span class="n">clim</span> <span class="o">==</span> <span class="s1">&#39;from_zero&#39;</span><span class="p">:</span>
            <span class="n">clim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data_range</span><span class="p">))</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;inferno&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;if input argument clim is a string, it has to be one of (&quot;basic&quot;, &quot;diverge&quot;, &quot;from_zero&quot;)&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clim</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;inferno&#39;</span>

    <span class="k">return</span> <span class="n">clim</span><span class="p">,</span> <span class="n">cmap</span></div>


<div class="viewcode-block" id="DataFastSubplot"><a class="viewcode-back" href="../index.html#PyNeuroPlot.DataFastSubplot">[docs]</a><span class="k">def</span> <span class="nf">DataFastSubplot</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gap</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">tf_axis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subplot_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">tf_nmlz</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">clim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    effecient way to plot data when there are many panels: it first put every panel into a big picture before plotting</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">N_data</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">data_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data_type</span> <span class="o">=</span> <span class="s1">&#39;line&#39;</span>

    <span class="k">if</span> <span class="n">layout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>             <span class="c1"># if not give, set layout to be the number of data</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="n">N_data</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>   <span class="c1"># if is a single number, turn to [num_row, num_col]</span>
        <span class="n">ncol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">layout</span><span class="p">)))</span>
        <span class="n">nrow</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">layout</span><span class="o">/</span><span class="n">ncol</span><span class="p">))</span>
        <span class="n">layout</span> <span class="o">=</span> <span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">layout</span>

    <span class="c1"># plt.axes([0.05, 0.02, 0.94, 0.90])</span>

    <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;mesh&#39;</span> <span class="ow">or</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;spectrum&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; get the sizes &quot;&quot;&quot;</span>
        <span class="n">ny_mesh</span><span class="p">,</span> <span class="n">nx_mesh</span> <span class="o">=</span> <span class="n">data_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>    <span class="c1"># size of every panel</span>
        <span class="n">nx_gap</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">nx_mesh</span> <span class="o">*</span> <span class="n">gap</span><span class="p">))</span>     <span class="c1"># size of gap between panels</span>
        <span class="n">ny_gap</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">ny_mesh</span> <span class="o">*</span> <span class="n">gap</span><span class="p">))</span>
        <span class="n">nx_cell</span> <span class="o">=</span> <span class="n">nx_mesh</span><span class="o">+</span><span class="n">nx_gap</span>                 <span class="c1"># a cell is panel with gap</span>
        <span class="n">ny_cell</span> <span class="o">=</span> <span class="n">ny_mesh</span><span class="o">+</span><span class="n">ny_gap</span>
        <span class="n">nx_shift</span> <span class="o">=</span> <span class="n">nx_gap</span><span class="o">//</span><span class="mi">2</span>                     <span class="c1"># shift the starting point of panel to be half the gap</span>
        <span class="n">ny_shift</span> <span class="o">=</span> <span class="n">ny_gap</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">nx_canvas</span> <span class="o">=</span> <span class="p">(</span><span class="n">nx_mesh</span> <span class="o">+</span> <span class="n">nx_gap</span><span class="p">)</span> <span class="o">*</span> <span class="n">ncol</span>    <span class="c1"># size of canvas</span>
        <span class="n">ny_canvas</span> <span class="o">=</span> <span class="p">(</span><span class="n">ny_mesh</span> <span class="o">+</span> <span class="n">ny_gap</span><span class="p">)</span> <span class="o">*</span> <span class="n">nrow</span>

        <span class="c1"># initialize the data for canvas</span>
        <span class="n">mesh_canvas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ny_canvas</span><span class="p">,</span> <span class="n">nx_canvas</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="c1"># contains the data for mask (create frames between panels)</span>
        <span class="n">mask_canvas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ny_canvas</span><span class="p">,</span> <span class="n">nx_canvas</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">xx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx_mesh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">yy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny_mesh</span><span class="p">)</span>


        <span class="sd">&quot;&quot;&quot; normalize individual mesh plot to range [0,1] before putting them together &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tf_nmlz</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_data</span><span class="p">):</span>
                <span class="n">cur_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">data_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">cur_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">data_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">cur_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">cur_max</span> <span class="o">-</span> <span class="n">cur_min</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot; put mesh plot together into the big canvas matrix &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">indx_in_canvas</span><span class="p">(</span><span class="n">indx</span><span class="p">,</span> <span class="n">rowcol</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">startend</span><span class="o">=</span><span class="s1">&#39;start&#39;</span><span class="p">):</span>
            <span class="c1"># function to compute the index on canvas</span>
            <span class="k">if</span> <span class="n">rowcol</span> <span class="o">==</span> <span class="s1">&#39;row&#39;</span><span class="p">:</span>
                <span class="n">n_cell</span> <span class="o">=</span> <span class="n">ny_cell</span>
                <span class="n">n_shift</span>  <span class="o">=</span> <span class="n">ny_shift</span>
                <span class="n">n_mesh</span> <span class="o">=</span> <span class="n">ny_mesh</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_cell</span> <span class="o">=</span> <span class="n">nx_cell</span>
                <span class="n">n_shift</span> <span class="o">=</span> <span class="n">nx_shift</span>
                <span class="n">n_mesh</span> <span class="o">=</span> <span class="n">nx_mesh</span>
            <span class="k">return</span> <span class="n">indx</span> <span class="o">*</span> <span class="n">n_cell</span> <span class="o">+</span> <span class="n">n_shift</span> <span class="o">+</span> <span class="n">n_mesh</span> <span class="o">*</span> <span class="p">(</span><span class="n">startend</span><span class="o">==</span><span class="s1">&#39;end&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">startend</span><span class="o">!=</span><span class="s1">&#39;middle&#39;</span> <span class="k">else</span> <span class="n">indx</span> <span class="o">*</span> <span class="n">n_cell</span> <span class="o">+</span> <span class="n">n_shift</span> <span class="o">+</span> <span class="n">n_mesh</span><span class="o">/</span><span class="mi">2</span>

        <span class="k">def</span> <span class="nf">map_value_in_cavas</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">xy</span><span class="o">==</span><span class="s1">&#39;x&#39;</span><span class="p">:</span>
                <span class="n">range_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xx</span><span class="p">))</span>
                <span class="n">n_mesh</span> <span class="o">=</span> <span class="n">nx_mesh</span>
                <span class="n">indx</span> <span class="o">=</span> <span class="n">col</span>
                <span class="n">rowcol</span> <span class="o">=</span> <span class="s1">&#39;col&#39;</span>
            <span class="k">elif</span> <span class="n">xy</span><span class="o">==</span><span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">range_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">yy</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">yy</span><span class="p">))</span>
                <span class="n">n_mesh</span> <span class="o">=</span> <span class="n">ny_mesh</span>
                <span class="n">indx</span> <span class="o">=</span> <span class="n">row</span>
                <span class="n">rowcol</span> <span class="o">=</span> <span class="s1">&#39;row&#39;</span>
            <span class="k">return</span> <span class="mf">1.0</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="n">range_value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">range_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">range_value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> \
                   <span class="o">*</span> <span class="p">(</span><span class="n">n_mesh</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">indx</span><span class="p">,</span> <span class="n">rowcol</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_data</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="n">ncol</span>    <span class="c1"># row index of panel</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span>  <span class="n">ncol</span>    <span class="c1"># col index of panel</span>
            <span class="c1"># fill the mesh data of the panel in to the right location of canvas matrix for mesh plot</span>
            <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;spectrum&#39;</span><span class="p">:</span>
                <span class="n">mesh_canvas</span><span class="p">[</span><span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="s1">&#39;start&#39;</span><span class="p">)</span> <span class="p">:</span> <span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="s1">&#39;end&#39;</span><span class="p">),</span>
                            <span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">)</span> <span class="p">:</span> <span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">,</span><span class="s1">&#39;end&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">data_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mesh_canvas</span><span class="p">[</span><span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="s1">&#39;start&#39;</span><span class="p">)</span> <span class="p">:</span> <span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="s1">&#39;end&#39;</span><span class="p">),</span>
                            <span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">)</span> <span class="p">:</span> <span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">,</span><span class="s1">&#39;end&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># fill value 1.0 to the pixels that contains mesh data in the canvas matrix for mask</span>
            <span class="n">mask_canvas</span><span class="p">[</span><span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="s1">&#39;start&#39;</span><span class="p">)</span> <span class="p">:</span> <span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="s1">&#39;end&#39;</span><span class="p">),</span>
                        <span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">)</span> <span class="p">:</span> <span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">,</span><span class="s1">&#39;end&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># create colormap for mask (transparent if 0.0, opaque if 1.0)</span>
        <span class="n">cmap_mask</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;cmap_mask&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)],</span> <span class="n">N</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot; determine color limit &quot;&quot;&quot;</span>
        <span class="n">data_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">mesh_canvas</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">mesh_canvas</span><span class="p">)]</span>
        <span class="n">clim</span><span class="p">,</span> <span class="n">cmap_auto</span> <span class="o">=</span> <span class="n">DetermineClimCmap</span><span class="p">(</span><span class="n">clim</span><span class="p">,</span> <span class="n">data_range</span><span class="o">=</span><span class="n">data_range</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap_auto</span>

        <span class="sd">&quot;&quot;&quot; plot big matrix containing all mesh plots &quot;&quot;&quot;</span>
        <span class="c1"># # mesh data</span>
        <span class="k">if</span> <span class="n">N_data</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">data_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">clim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">clim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mesh_canvas</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">clim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">clim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
            <span class="c1"># # maks that forms the frames that seperates data panels</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask_canvas</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_mask</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>

            <span class="sd">&quot;&quot;&quot; make plot look better &quot;&quot;&quot;</span>
            <span class="c1"># set y axis direction in the imshow format</span>
            <span class="n">ylim</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">())</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span> <span class="n">ylim</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">ylim</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

            <span class="sd">&quot;&quot;&quot; plot panel axis and ticks &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">tf_axis</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_data</span><span class="p">):</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="n">ncol</span>    <span class="c1"># row index of panel</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span>  <span class="n">ncol</span>    <span class="c1"># col index of panel</span>
                    <span class="c1"># axis line</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">),</span> <span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                             <span class="p">[</span><span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">],</span>
                             <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">)</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">)</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">],</span>
                             <span class="p">[</span><span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">)</span> <span class="p">,</span> <span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                             <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="c1"># axis tick</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">map_value_in_cavas</span><span class="p">(</span><span class="n">auto_tick</span><span class="p">(</span><span class="n">xx</span><span class="p">),</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">),</span> <span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span>
                               <span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">ny_gap</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">map_value_in_cavas</span><span class="p">(</span><span class="n">auto_tick</span><span class="p">(</span><span class="n">yy</span><span class="p">),</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">),</span> <span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span>
                               <span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">nx_gap</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

            <span class="sd">&quot;&quot;&quot; plot labels &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">subplot_label</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subplot_label</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subplot_label</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># 2 dimension subplot layout</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrow</span><span class="p">):</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="s1">&#39;middle&#39;</span><span class="p">),</span> <span class="n">subplot_label</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncol</span><span class="p">):</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">,</span> <span class="s1">&#39;middle&#39;</span><span class="p">),</span> <span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">subplot_label</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># 1 dimension subplot layout</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_data</span><span class="p">):</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="n">ncol</span>    <span class="c1"># row index of panel</span>
                        <span class="n">col</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span>  <span class="n">ncol</span>    <span class="c1"># col index of panel</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">),</span> <span class="n">indx_in_canvas</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">subplot_label</span><span class="p">[</span><span class="n">i</span><span class="p">])</span></div>




<span class="k">def</span> <span class="nf">center2edge</span><span class="p">(</span><span class="n">centers</span><span class="p">):</span>
    <span class="c1"># tool function to get edges from centers for plt.pcolormesh</span>
    <span class="n">centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">centers</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">centers</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>     <span class="c1"># assumes even spacing</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">centers</span><span class="p">)</span> <span class="ow">is</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">centers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">centers</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">centers</span> <span class="o">-</span> <span class="n">dx</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">centers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dx</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>      <span class="c1"># more universal</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">centers</span><span class="p">)</span> <span class="ow">is</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">centers</span> <span class="o">-</span> <span class="n">dx</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">centers</span> <span class="o">+</span> <span class="n">dx</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">centers</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">centers</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.0</span>
            <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">centers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">-</span> <span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span> <span class="n">centers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">centers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">centers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">edges</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">edges</span>


<div class="viewcode-block" id="prettyfloat"><a class="viewcode-back" href="../index.html#PyNeuroPlot.prettyfloat">[docs]</a><span class="k">def</span> <span class="nf">prettyfloat</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    function to cut the long float numbers for print</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">:</span>
             <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">prettyfloat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span> <span class="p">)</span>  <span class="c1"># through recursion</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="nb">input</span>
    <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="gen_distinct_colors"><a class="viewcode-back" href="../index.html#PyNeuroPlot.gen_distinct_colors">[docs]</a><span class="k">def</span> <span class="nf">gen_distinct_colors</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">luminance</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;discrete&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    tool funciton to generate n distinct colors for plotting</span>

<span class="sd">    :param n:          num of colors</span>
<span class="sd">    :param luminance:  num between [0,1]</span>
<span class="sd">    :param alhpa:      num between [0,1]</span>
<span class="sd">    :param style:      sting, &#39;discrete&#39;, or &#39;continuous&#39;</span>
<span class="sd">    :return:           n*4 rgba color matrix</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s1">&#39;discrete&#39;</span><span class="p">:</span>
        <span class="n">magic_number</span> <span class="o">=</span> <span class="mf">0.618</span>  <span class="c1"># from the golden ratio, to make colors evely distributed</span>
        <span class="n">initial_number</span> <span class="o">=</span> <span class="mf">0.25</span>
        <span class="n">colors_ini</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">rainbow</span><span class="p">((</span><span class="n">initial_number</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="o">*</span> <span class="n">magic_number</span> <span class="o">%</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">style</span> <span class="o">==</span> <span class="s1">&#39;continuous&#39;</span><span class="p">:</span>
        <span class="n">colors_ini</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">rainbow</span><span class="p">(</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="n">n</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">magic_number</span> <span class="o">=</span> <span class="mf">0.618</span>  <span class="c1"># from the golden ratio, to make colors evely distributed</span>
        <span class="n">initial_number</span> <span class="o">=</span> <span class="mf">0.25</span>
        <span class="n">colors_ini</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">rainbow</span><span class="p">((</span><span class="n">initial_number</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="o">*</span> <span class="n">magic_number</span> <span class="o">%</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">colors_ini</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">luminance</span><span class="p">,</span> <span class="n">luminance</span><span class="p">,</span> <span class="n">luminance</span><span class="p">,</span> <span class="n">alpha</span><span class="p">]])</span></div>


<div class="viewcode-block" id="keep_less_than"><a class="viewcode-back" href="../index.html#PyNeuroPlot.keep_less_than">[docs]</a><span class="k">def</span> <span class="nf">keep_less_than</span><span class="p">(</span><span class="n">list_in</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    keep less than n element, through recursion</span>

<span class="sd">    :param list_in: input list, 1D</span>
<span class="sd">    :param n:       criterion</span>
<span class="sd">    :return:        list of a subset of the original list with elemetns smaller than n</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_in</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span><span class="o">&lt;=</span><span class="n">n</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">list_in</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">list_in</span> <span class="o">=</span> <span class="p">[</span> <span class="n">list_in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">return</span> <span class="n">keep_less_than</span><span class="p">(</span><span class="n">list_in</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span></div>


<div class="viewcode-block" id="cal_rc"><a class="viewcode-back" href="../index.html#PyNeuroPlot.cal_rc">[docs]</a><span class="k">def</span> <span class="nf">cal_rc</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    calculate n_row, n_column automatically, for subplot layout, obsolete, should switch to AutoRowCol</span>

<span class="sd">    :return: [n_rows, n_cols]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">N</span><span class="p">)))</span>
    <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">N</span> <span class="o">/</span> <span class="n">n_rows</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">]</span></div>


<div class="viewcode-block" id="isSingle"><a class="viewcode-back" href="../index.html#PyNeuroPlot.isSingle">[docs]</a><span class="k">def</span> <span class="nf">isSingle</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check whether input is does not contain multiple items, works for lists and tuples</span>

<span class="sd">    e.g. 1, 3.0, &#39;a string&#39;, [1.0], or (&#39;afe&#39;) returns True, [1,2] returns false</span>
<span class="sd">    :param x:  list, tuple, string or number</span>
<span class="sd">    :return:   Ture of False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">isSingle</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="share_clim"><a class="viewcode-back" href="../index.html#PyNeuroPlot.share_clim">[docs]</a><span class="k">def</span> <span class="nf">share_clim</span><span class="p">(</span><span class="n">h_ax</span><span class="p">,</span> <span class="n">c_lim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    tool funciton to share clim (make sure c_lim of given axes are the same), call after plotting all images</span>

<span class="sd">    :param h_ax: list of axes to reset clim</span>
<span class="sd">    :param c_lim: if None, calculate automatically, otherwise, use the given clim, e.g. [-1, 5]</span>
<span class="sd">    :return:     c_lim</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h_ax_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">h_ax</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">c_lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>    <span class="c1"># if not given, calculate the clim to be the smallest possible range to accommodate all axes</span>
        <span class="n">c_lim</span> <span class="o">=</span> <span class="p">[</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">Inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">Inf</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">h_ax_all</span><span class="p">:</span>  <span class="c1"># get clim</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plt</span><span class="o">.</span><span class="n">gci</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">c_lim_new</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gci</span><span class="p">()</span><span class="o">.</span><span class="n">get_clim</span><span class="p">()</span>
                <span class="n">c_lim</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">c_lim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c_lim_new</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">c_lim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c_lim_new</span><span class="p">[</span><span class="mi">1</span><span class="p">]])]</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">h_ax_all</span><span class="p">:</span>  <span class="c1"># set clim</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plt</span><span class="o">.</span><span class="n">gci</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="n">c_lim</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c_lim</span></div>



<div class="viewcode-block" id="auto_tick"><a class="viewcode-back" href="../index.html#PyNeuroPlot.auto_tick">[docs]</a><span class="k">def</span> <span class="nf">auto_tick</span><span class="p">(</span><span class="n">data_range</span><span class="p">,</span> <span class="n">max_tick</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">tf_inside</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    tool function that automatically calculate optimal ticks based on range and the max number of ticks</span>
<span class="sd">    :param data_range:   range of data, e.g. [-0.1, 0.5]</span>
<span class="sd">    :param max_tick:     max number of ticks, an interger, default to 10</span>
<span class="sd">    :param tf_inside:    True/False if only allow ticks to be inside</span>
<span class="sd">    :return:             list of ticks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_range</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_range</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">data_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_range</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">data_range</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
    <span class="n">data_span</span> <span class="o">=</span> <span class="n">data_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">data_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="mf">10.0</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">data_span</span><span class="p">))</span>    <span class="c1"># scale of data as the order of 10, e.g. 1, 10, 100, 0.1, 0.01, ...</span>
    <span class="n">list_tick_size_nmlz</span> <span class="o">=</span> <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">]</span>   <span class="c1"># possible tick sizes for normalized data in range [1, 10]</span>
    <span class="n">tick_size_nmlz</span> <span class="o">=</span> <span class="mf">1.0</span>     <span class="c1"># initial tick size for normalized data</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list_tick_size_nmlz</span><span class="p">)):</span>                 <span class="c1"># every loop reduces tick size thus increases tick number</span>
        <span class="n">num_tick</span> <span class="o">=</span> <span class="n">data_span</span><span class="o">/</span><span class="n">scale</span><span class="o">/</span><span class="n">list_tick_size_nmlz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="c1"># number of ticks for the current tick size</span>
        <span class="k">if</span> <span class="n">num_tick</span> <span class="o">&gt;</span> <span class="n">max_tick</span><span class="p">:</span>                               <span class="c1"># if too many ticks, break loop</span>
            <span class="n">tick_size_nmlz</span> <span class="o">=</span> <span class="n">list_tick_size_nmlz</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">break</span>
    <span class="n">tick_size</span> <span class="o">=</span> <span class="n">tick_size_nmlz</span> <span class="o">*</span> <span class="n">scale</span>             <span class="c1"># tick sizse for the original data</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">tick_size</span><span class="p">,</span> <span class="n">data_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">tick_size</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">())</span><span class="o">*</span><span class="n">tick_size</span>    <span class="c1"># list of ticks</span>

    <span class="k">if</span> <span class="n">tf_inside</span><span class="p">:</span>     <span class="c1"># if only allow ticks within the given range</span>
        <span class="n">ticks</span> <span class="o">=</span> <span class="n">ticks</span><span class="p">[</span> <span class="p">(</span><span class="n">ticks</span><span class="o">&gt;=</span><span class="n">data_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">ticks</span><span class="o">&lt;=</span><span class="n">data_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

    <span class="k">return</span> <span class="n">ticks</span></div>



<span class="sd">&quot;&quot;&quot; ========== ========== obsolete function ========== ========== &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SignalPlot"><a class="viewcode-back" href="../index.html#PyNeuroPlot.SignalPlot">[docs]</a><span class="k">def</span> <span class="nf">SignalPlot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">data3D</span><span class="p">,</span> <span class="n">sk_std</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    function to generate plot using data3D, (N_trial * N_ts * N_signal)</span>

<span class="sd">    :param ts:      timestamps (in sec)</span>
<span class="sd">    :param data3D:  data</span>
<span class="sd">    :param sk_std:  smooth kernel std (in sec); default is nan, do not smooth data</span>
<span class="sd">    :return:        plot handle</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tf_smooth_every_trial</span> <span class="o">=</span> <span class="kc">False</span>    <span class="c1"># very slow if set to true</span>

    <span class="k">if</span> <span class="n">data3D</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">data2D</span> <span class="o">=</span> <span class="n">data3D</span>
        <span class="p">(</span><span class="n">N_tr</span><span class="p">,</span> <span class="n">N_ts</span><span class="p">)</span> <span class="o">=</span> <span class="n">data2D</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">data3D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">N_tr</span><span class="p">,</span><span class="n">N_ts</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">data3D</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data2D</span>


    <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">N_ts</span><span class="p">,</span> <span class="n">N_sign</span><span class="p">)</span> <span class="o">=</span> <span class="n">data3D</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="n">sk_std</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>   <span class="c1"># condition for using smoothness kernel</span>
        <span class="n">ts_interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>        <span class="c1"># get sampling interval</span>
        <span class="n">kernel_std</span>  <span class="o">=</span> <span class="n">sk_std</span><span class="o">/</span><span class="n">ts_interval</span>                  <span class="c1"># std in frames</span>
        <span class="n">kernel_len</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">kernel_std</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>      <span class="c1"># num of frames, 3*std on each side, an odd number</span>
        <span class="n">smooth_kernel</span> <span class="o">=</span> <span class="n">sgn</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="n">kernel_len</span><span class="p">,</span><span class="n">kernel_std</span><span class="p">)</span>
        <span class="n">smooth_kernel</span> <span class="o">=</span> <span class="n">smooth_kernel</span><span class="o">/</span><span class="n">smooth_kernel</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># normalized smooth kernel</span>

        <span class="k">if</span> <span class="n">tf_smooth_every_trial</span><span class="p">:</span>
            <span class="n">smooth_kernel_3D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">smooth_kernel_3D</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">smooth_kernel</span>
            <span class="n">data3D_smooth</span> <span class="o">=</span> <span class="n">sgn</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">data3D</span><span class="p">,</span> <span class="n">smooth_kernel_3D</span><span class="p">,</span> <span class="s1">&#39;same&#39;</span><span class="p">)</span>

            <span class="n">data_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data3D_smooth</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">N_ts</span><span class="p">,</span> <span class="n">N_sign</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_sign</span><span class="p">):</span>
                <span class="n">data_plot</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data3D</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">smooth_kernel</span><span class="p">,</span> <span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data3D</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


    <span class="n">name_colormap</span> <span class="o">=</span> <span class="s1">&#39;rainbow&#39;</span>
    <span class="n">cycle_color</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">name_colormap</span><span class="p">)(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N_sign</span><span class="p">))</span>
    <span class="n">cycle_linestyle</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">]</span>

    <span class="n">hl_plot</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># handle list</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_sign</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
        <span class="n">h_plot</span><span class="p">,</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">data_plot</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">cycle_color</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">cycle_color</span><span class="p">)]</span><span class="o">*</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">cycle_linestyle</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">cycle_linestyle</span><span class="p">)],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span> <span class="p">)</span>
        <span class="n">hl_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h_plot</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">hl_plot</span></div>


<span class="k">def</span> <span class="nf">NeuroPlot</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="p">[],</span> <span class="n">sk_std</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">tf_seperate_window</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tf_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="p">[</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">N_sgnl</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="n">tf_seperate_window</span><span class="p">:</span>
        <span class="n">lh_fig</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_sgnl</span><span class="p">):</span>
            <span class="n">lh_fig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">9</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

    <span class="k">if</span> <span class="s1">&#39;cdtn&#39;</span> <span class="ow">in</span> <span class="n">data_neuro</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">N_cndt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;cdtn&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">N_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">N_cndt</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">N_row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">N_cndt</span><span class="o">/</span><span class="n">N_col</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">[</span><span class="n">N_row</span><span class="p">,</span> <span class="n">N_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">layout</span>

        <span class="n">axes1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">N_row</span><span class="p">,</span> <span class="n">N_col</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_cndt</span><span class="p">):</span>
            <span class="n">cdtn</span> <span class="o">=</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;cdtn&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tf_seperate_window</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_sgnl</span><span class="p">):</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">lh_fig</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">N_row</span><span class="p">,</span> <span class="n">N_col</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">axes1</span><span class="p">)</span>
                    <span class="n">hl_plot</span> <span class="o">=</span> <span class="n">SignalPlot</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">],</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;cdtn_indx&#39;</span><span class="p">][</span><span class="n">cdtn</span><span class="p">],</span> <span class="p">:,</span> <span class="p">[</span><span class="n">j</span><span class="p">]],</span> <span class="n">sk_std</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">prettyfloat</span><span class="p">(</span><span class="n">cdtn</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">lh_fig</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;signal_info&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">N_row</span><span class="p">,</span> <span class="n">N_col</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">axes1</span><span class="p">)</span>
                <span class="n">hl_plot</span> <span class="o">=</span> <span class="n">SignalPlot</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">],</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;cdtn_indx&#39;</span><span class="p">][</span><span class="n">cdtn</span><span class="p">],</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">sk_std</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tf_legend</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">hl_plot</span><span class="p">,</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;signal_info&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">labelspacing</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">},</span> <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">prettyfloat</span><span class="p">(</span><span class="n">cdtn</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hl_plot</span> <span class="o">=</span> <span class="n">SignalPlot</span><span class="p">(</span><span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">],</span> <span class="n">data_neuro</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">sk_std</span> <span class="p">)</span>
        <span class="c1"># plt.legend(hl_plot, data_neuro[&#39;signal_info&#39;][&#39;name&#39;].tolist())</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">prettyfloat</span><span class="p">(</span><span class="n">cdtn</span><span class="p">))</span>

    <span class="k">return</span> <span class="mi">1</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Shaobo Guan, Ruobing Xia.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>